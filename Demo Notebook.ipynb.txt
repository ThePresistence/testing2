{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "48f623f5-ab59-4627-b0fe-64397d819727",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "from pyspark.sql.functions import *\n",
    "from pyspark.sql.types import DoubleType,IntegerType,StringType\n",
    "import pyspark.sql.functions as F\n",
    "from pyspark.sql.window import Window"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "3a2e6ecf-6400-40a5-92e3-a0f9c2c6ae02",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "\n",
    "df_lead_report_tab= spark.sql(\"\"\"select cast(LEAD_ID as int) LEAD_ID_L,\n",
    "                   FIRST_NAME_AR,\n",
    "                   LAST_NAME_AR,\n",
    "                   MANUAL_LEAD,\n",
    "                   C_MANUFACTURER,\n",
    "                   C_MODEL,\n",
    "                   GF_SESSION_COUNT,\n",
    "                   GF_PAGE_VIEW,\n",
    "                   GF_CLIENT_ID,\n",
    "                   BDC_NEXT_ACTION_20,\n",
    "                   LAST_MANAGEMENT_NOTE,\n",
    "                   PROCESS_TYPE,\n",
    "                   EMPLOYEE_ID,\n",
    "                   STATUS,\n",
    "                   ORIGIN,\n",
    "                   CREATED_BY,\n",
    "                   CREATED_ON,\n",
    "                   ENQUIRY_ID as ENQUIRY_ID_L,\n",
    "                   LEAD_SOURCE,\n",
    "                   LANGUAGE,\n",
    "                   FIRST_NAME_EN,\n",
    "                   LAST_NAME_EN,\n",
    "                   CLOSED_DATE,\n",
    "                   MEDIUM,\n",
    "                   SOURCE,\n",
    "                   GF_CAMPAIGN,\n",
    "                   TRADE_IN_FLAG,\n",
    "                   GF_REC_DATE,\n",
    "                   GF_MAKE_AR,\n",
    "                   GF_MODEL_AR,\n",
    "                   NOTES_EN,\n",
    "                   GF_URL,\n",
    "                   GF_KEYWORD,\n",
    "                   REVIEWED_USER,\n",
    "                   REVIEWED_DATE,\n",
    "                   CURRENT_VEHICLE_DRI_MODEL,\n",
    "                   CURRENT_VEHICLE_DRI_MAKE,\n",
    "                   LEAD_PASSED_ON,\n",
    "                   LEAD_PASSED_BY,\n",
    "                   LEAD_PASSED_ON_TIM,\n",
    "                   NEXT_ACTION_DATE,\n",
    "                   FIRST_MANAGEMENT_ACTION_DATE,\n",
    "                   SALES_EXECUTIVE_ASSIGNED_DATE,\n",
    "                   CLOSE_REASON_DESCRIPTION,\n",
    "                   MANAGEMENT_NEXT_ACTION_DATE,\n",
    "                   LAST_MANAGEMENT_ACTION_DATE,\n",
    "                   FIRST_MANAGEMENT_NOTE,\n",
    "                   CAMPAIGN\n",
    "                   from silver.lead_data\"\"\")\n",
    "df_lead_report_tab.createOrReplaceTempView('lead_report_tab')\n",
    "\n",
    "\n",
    "\n",
    "df_enquiry_report_tab=spark.sql(\"\"\"select cast(ENQUIRY_ID as int) ENQUIRY_ID_E,\n",
    "                      FIRST_ACTION_DATE,\n",
    "                      cast(LEAD_ID as int) LEAD_ID_E,\n",
    "                      ENQUIRY_TYPE,\n",
    "                      AGG_APPOINTMENT_NUMBER,\n",
    "                      AGG_FOLL_NUMBER,\n",
    "                      APPOINTMENT_DATE_FIRST,\n",
    "                      APPOINTMENT_DATE_LAST,\n",
    "                      CREATED_ON,\n",
    "                      BE_BACKS,\n",
    "                      APPOINTMENT_SHOWS,\n",
    "                      STATUS,\n",
    "                      APPOINTMENT_START_DATE,\n",
    "                      APPOINTMENT_START_TIME,\n",
    "                      HYBRIS_CAMPAIGN\n",
    "                      from silver.enquiry_data\"\"\")\n",
    "df_enquiry_report_tab.createOrReplaceTempView('enquiry_report_tab')\n",
    "\n",
    "#ZIF_FFT_BI_ACTVT\n",
    "df_ft_bi_interface=spark.sql(\"\"\"select ENQUIRY_NUMBER,\n",
    "                                       TEST_DRIVE_PRINT,\n",
    "                                       LAST_STATUS_UPDATE,\n",
    "                                       SAP_ORDER_NUMBER,\n",
    "                                       MAKE,\n",
    "                                       FIRST_ORDERED_DATE,\n",
    "                                       FIRST_ORDERED,\n",
    "                                       BUSINESS_MANAGER,\n",
    "                                       FASTRACK_INTERFACE_FINANCIAL_SCHEME_NAME,\n",
    "                                       TEST_DRIVE_PRINT,\n",
    "                                       RETURN_DATE,\n",
    "                                       LOCATOR_DATE,\n",
    "                                       OFFER_DATE,\n",
    "                                       CREATE_SALES_ORDER,\n",
    "                                       PURCHASE_AGREEMENT,\n",
    "                                       DELIVERED,\n",
    "                                       CREATE_SALES_ORDER_TIME\n",
    "                                   from silver.bi_interface\"\"\")\n",
    "df_ft_bi_interface.createOrReplaceTempView('ft_bi_interface')\n",
    "\n",
    "#ZIF_FFT_BI_TRADE\n",
    "df_ft_bi_trade_in=spark.sql(\"\"\"select cast(ENQUIRY_NUMBER as int) as ENQUIRY_NUMBER_T,\n",
    "                                CREATION_DATE,APPRAISAL_COMPLETED_DATE,\n",
    "                      TI_FIRST_VALUE,\n",
    "                      TI_FIRST_VALUE_DATE,\n",
    "                      TI_FIRST_VALUE_USER,\n",
    "                      TI_LAST_VALUE,\n",
    "                      TI_LAST_VALUE_DATE,\n",
    "                      TI_LAST_VLAUE_USER,\n",
    "                      TI_ALLOWANCE,\n",
    "                      TI_ALLOWANCE_DATE,\n",
    "                      TI_ALLOWANCE_USER_NAME,\n",
    "                      TI_REMOVED_DATE,\n",
    "                      TI_REMOVED_USER from silver.trade_in\"\"\")\n",
    "df_ft_bi_trade_in.createOrReplaceTempView('ft_bi_trade_in')\n",
    "\n",
    "\n",
    "# ZIF_FFT_BI_SALES\n",
    "df_ft_sales_attributes = spark.sql(\"\"\"select cast(ENQUIRY_NUMBER as int) ENQUIRY_NUMBER_S,\n",
    "                      CUSTOMER_ID as CUSTOMER_ID_S,\n",
    "                      SOURCE_CONTACT_TYPE,\n",
    "                      ENQUIRY_SOURCE,\n",
    "                      PREVIOUS_VEHICLE_MAKE,\n",
    "                      PREVIOUS_VEHICLE_MODEL,\n",
    "                      EXCHANGE_TAKEN,\n",
    "                      DOWNPAYMENT,\n",
    "                      SALES_RETURNED,\n",
    "                      MATERIAL_DESCRIPTION,\n",
    "                      VARIANT,\n",
    "                      MATERIAL_NUMBER,\n",
    "                      VARIANT_CODE,\n",
    "                      VIN_NO,\n",
    "                      FRANCHISE,\n",
    "                      VEHICLE_OF_INTEREST,\n",
    "                      LOST_REASON,\n",
    "                      SALES_TYPE,\n",
    "                      ---CUSTOMER_FULL_NAME,\n",
    "                      SALES_OFFICE,\n",
    "                      BRANCE_MANAGER_NAME,\n",
    "                      SALES_EXECUTIVE_NAME,\n",
    "                      LOST_TO_REASON,\n",
    "                      TRADEIN_FLAG,\n",
    "                      CURRENT_MAKE,\n",
    "                      CURRENT_MODEL,\n",
    "                      ENQUIRY_CREATED_DATE,\n",
    "                      STATUS,\n",
    "                      NEW_USED,\n",
    "                      EXPECTED_DELIVERY_DATE,\n",
    "                      ACTUAL_DELIVERY_DATE,\n",
    "                      DEMO_TAKEN,\n",
    "                      TRADEINMATFLG,\n",
    "                      TRADEIN_VIN,\n",
    "                      BRANCH_ID,\n",
    "                      REJ_REASON,\n",
    "                      TRPOVAL,\n",
    "                      TRSTATUSDD,\n",
    "                      REJ_REASON_TR,\n",
    "                      AEDAT,\n",
    "                      BLDAT\n",
    "                      --ENQUIRY_CREATED_TIME\n",
    "                      from silver.sales\"\"\")\n",
    "df_ft_sales_attributes.createOrReplaceTempView('ft_sales_attributes')\n",
    "\n",
    "# ZIF_FFT_BI_CUST\n",
    "df_ft_customer_attributes=spark.sql(\"\"\"select\n",
    "                                       CUSTOMER_ID,\n",
    "                                       cast(CUSTOMER_ID as int) CUSTOMER_ID_C,\n",
    "                                       CUSTOMER_NAME,\n",
    "                                       EID_NUMBER_SINGLE,\n",
    "                                       EID_NUMBER,\n",
    "                                       GENDER,\n",
    "                                       NATIONALITY,\n",
    "                                       DATE_OF_BIRTH,\n",
    "                                       PO_BOX,\n",
    "                                       CITY,\n",
    "                                       HOUSE_NUMBER,\n",
    "                                       BUILDING_NAME,\n",
    "                                       STREET_NAME_NUMBER,\n",
    "                                       AREA,\n",
    "                                       CITY_1,\n",
    "                                       CITY_POSTAL_CODE,\n",
    "                                       EXISTING_CUSTOMER,\n",
    "                                       FIRST_NAME,\n",
    "                                       LAST_NAME,\n",
    "                                       EMAIL_ADDRESS,\n",
    "                                       TELEPHONE_NO,\n",
    "                                       NEAREST_LAND_MARK\n",
    "                                    from silver.customer_master\"\"\")\n",
    "df_ft_customer_attributes.createOrReplaceTempView('ft_customer_attributes')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "01191a19-f042-44ae-a33a-12fd7db18e3b",
     "showTitle": false,
     "title": ""
    }
   },
   "source": [
    "# Combining the Dataframes And Renaming The Column Names"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "1229d7e6-c79c-400d-81b7-9828ab9cf932",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final_1=spark.sql(\"\"\" select e.ENQUIRY_ID_E as EnquiryNo,\n",
    "                      e.FIRST_ACTION_DATE as FirstActionDate,\n",
    "                      e.LEAD_ID_E,\n",
    "                      e.ENQUIRY_TYPE as EnquiryType,\n",
    "                      e.AGG_APPOINTMENT_NUMBER as ApptCount,\n",
    "                      e.APPOINTMENT_DATE_FIRST as FirstVisit,\n",
    "                      e.APPOINTMENT_DATE_LAST as LastVisit,\n",
    "                      e.BE_BACKS as BeBacks,\n",
    "                      e.APPOINTMENT_SHOWS as ApptShows,\n",
    "                      e.STATUS as AppointmentStatusName,\n",
    "                      e.APPOINTMENT_START_DATE as AppointmentDate,\n",
    "                      e.APPOINTMENT_START_TIME,\n",
    "                      e.CREATED_ON as EnquiryCreated,\n",
    "                      i.TEST_DRIVE_PRINT as Demo,\n",
    "                      i.LAST_STATUS_UPDATE as LastStatusUpdate,\n",
    "                      i.SAP_ORDER_NUMBER as SAPOrderNumber,\n",
    "                      i.MAKE as Make,\n",
    "                      i.FIRST_ORDERED_DATE as FirstOrdered,\n",
    "                      i.FIRST_ORDERED as 1stOrder,\n",
    "                      i.BUSINESS_MANAGER as BusinessManager,\n",
    "                      i.FASTRACK_INTERFACE_FINANCIAL_SCHEME_NAME as CashFinance,\n",
    "                      i.TEST_DRIVE_PRINT as TestDrivePrint,\n",
    "                      i.RETURN_DATE as ReturntoEnquiry,\n",
    "                      i.LOCATOR_DATE as Locator,\n",
    "                      i.OFFER_DATE as Offer,\n",
    "                      i.CREATE_SALES_ORDER as CreateSalesOrder,\n",
    "                      i.PURCHASE_AGREEMENT as PurchaseAgreement,\n",
    "                      i.DELIVERED as Delivered,\n",
    "                      i.CREATE_SALES_ORDER_TIME,\n",
    "                      --t.CREATION_DATE as DateCreated,\n",
    "                      t.APPRAISAL_COMPLETED_DATE as AppraisalCompleted,\n",
    "                      t.TI_FIRST_VALUE as TI1stValue,\n",
    "                      t.TI_FIRST_VALUE_DATE as TI1stValued,\n",
    "                      t.TI_FIRST_VALUE_USER as TI1stValueUser,\n",
    "                      t.TI_LAST_VALUE as TILastValue,\n",
    "                      t.TI_LAST_VALUE_DATE as TILastValued,\n",
    "                      t.TI_LAST_VLAUE_USER as TILastValueUser,\n",
    "                      t.TI_ALLOWANCE as TIAllowance,\n",
    "                      t.TI_ALLOWANCE_DATE as TIAllowanceSet,\n",
    "                      t.TI_ALLOWANCE_USER_NAME as TIAllowanceUserName,\n",
    "                      t.TI_REMOVED_DATE as TIRemoved,\n",
    "                      t.TI_REMOVED_USER as TIRemovedUser,\n",
    "                      s.ENQUIRY_NUMBER_S,\n",
    "                      s.CUSTOMER_ID_S,\n",
    "                      s.ENQUIRY_SOURCE as SourceOfEnquiry,\n",
    "                      s.PREVIOUS_VEHICLE_MODEL as Model,\n",
    "                      s.DOWNPAYMENT as DownPayment,\n",
    "                      s.MATERIAL_DESCRIPTION as Derivative,\n",
    "                      s.VARIANT as Variant,\n",
    "                      s.MATERIAL_NUMBER as ArticleCode,\n",
    "                      s.VARIANT_CODE as VariantCode,\n",
    "                      s.VIN_NO as `VIN_NO-VIN_Current`,\n",
    "                      s.FRANCHISE as Franchise,\n",
    "                      s.VEHICLE_OF_INTEREST as VehicleofInterest,\n",
    "                      s.LOST_REASON as LostReason,\n",
    "                      s.SALES_TYPE as SalesType,\n",
    "                      --s.CUSTOMER_FULL_NAME as Customer,\n",
    "                      s.SALES_OFFICE as Branch,\n",
    "                      s.SALES_EXECUTIVE_NAME as SalesExec,\n",
    "                      s.TRADEIN_FLAG as TradeInFlag,\n",
    "                      s.CURRENT_MAKE as CurrentMake,\n",
    "                      s.CURRENT_MODEL as CurrentModel,\n",
    "                      s.ENQUIRY_CREATED_DATE as DateCreated,\n",
    "                      s.STATUS as Status,\n",
    "                      s.NEW_USED as NewUsed,\n",
    "                      s.EXPECTED_DELIVERY_DATE as ExpDeliveryDate,\n",
    "                      s.ACTUAL_DELIVERY_DATE as ActDeliveryDate,\n",
    "                      s.DEMO_TAKEN as DemoTaken,\n",
    "                      s.TRADEINMATFLG as TradeInMatFlg,\n",
    "                      s.TRADEIN_VIN as TradeIn_VIN,\n",
    "                      s.BRANCH_ID as BranchId,\n",
    "                      s.REJ_REASON,\n",
    "                      s.TRPOVAL,\n",
    "                      s.TRSTATUSDD,\n",
    "                      s.REJ_REASON_TR,\n",
    "                      s.AEDAT,\n",
    "                      s.BLDAT\n",
    "                      --s.ENQUIRY_CREATED_TIME\n",
    "                      from enquiry_report_tab e\n",
    "                      left join ft_bi_interface i on e.ENQUIRY_ID_E = i.ENQUIRY_NUMBER\n",
    "                      left join ft_bi_trade_in t on e.ENQUIRY_ID_E = t.ENQUIRY_NUMBER_T\n",
    "                      left join ft_sales_attributes s on e.ENQUIRY_ID_E = s.ENQUIRY_NUMBER_S\n",
    "                       \"\"\")\n",
    "df_final_1.createOrReplaceTempView('final_1')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "763b1d29-cd98-4702-a617-63ff46058bdd",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "  df_final=spark.sql(\"\"\"\n",
    "                   select f.*,\n",
    "                   l.LEAD_ID_L,\n",
    "                   l.MANUAL_LEAD as ManualLead,\n",
    "                   l.C_MODEL,\n",
    "                   l.GF_SESSION_COUNT as SessionCount,\n",
    "                   l.GF_PAGE_VIEW as PageViewCount,\n",
    "                   l.GF_CLIENT_ID as ClientID,\n",
    "                   l.BDC_NEXT_ACTION_20 as BDCNextAction,\n",
    "                   l.LAST_MANAGEMENT_NOTE as LastManagementNotes,\n",
    "                   l.EMPLOYEE_ID as SalesExecID,\n",
    "                   l.ORIGIN as LeadChannel,\n",
    "                   l.CREATED_BY as ManualLeadCreatedBy,\n",
    "                   l.CREATED_ON as LeadCreated,\n",
    "                   l.LEAD_SOURCE as LeadSource,\n",
    "                   l.LANGUAGE as LanguageName,\n",
    "                   l.FIRST_NAME_EN as EnglishForename,\n",
    "                   l.CLOSED_DATE as ClosedDate,\n",
    "                   l.MEDIUM as Medium,\n",
    "                   l.SOURCE as LeadType,\n",
    "                   l.GF_REC_DATE as ReceivedDate,\n",
    "                   l.GF_MAKE_AR as ArabicMake,\n",
    "                   l.GF_MODEL_AR as ArabicModel,\n",
    "                   l.NOTES_EN as EnglishComment,\n",
    "                   l.GF_URL as LeadURL,\n",
    "                   l.GF_KEYWORD as KeywordsTerm,\n",
    "                   l.REVIEWED_USER as ReviewedUser,\n",
    "                   l.REVIEWED_DATE as ReviewedDate,\n",
    "                   l.CURRENT_VEHICLE_DRI_MODEL as EnglishModel,\n",
    "                   l.CURRENT_VEHICLE_DRI_MAKE as EnglishMake,\n",
    "                   l.LEAD_PASSED_ON as PassToBranchDate,\n",
    "                   l.LEAD_PASSED_BY as PassToBranchUser,\n",
    "                   l.LEAD_PASSED_ON_TIM ,\n",
    "                   l.NEXT_ACTION_DATE as NextActionDate,\n",
    "                   l.FIRST_MANAGEMENT_ACTION_DATE as FirstManagementActionDate,\n",
    "                   c.CUSTOMER_ID as Customer_ID_Connect,\n",
    "                   --c.CUSTOMER_ID_C as Customer_ID_Connect,\n",
    "                   c.CUSTOMER_NAME as Customer,\n",
    "                   c.EID_NUMBER_SINGLE as EIDNumber,\n",
    "                   c.GENDER as Gender,\n",
    "                   c.NATIONALITY as Nationality,\n",
    "                   c.DATE_OF_BIRTH as DOB,\n",
    "                   c.PO_BOX as POBox,\n",
    "                   c.CITY as Emirate,\n",
    "                   c.HOUSE_NUMBER as FlatVillaNo,\n",
    "                   c.BUILDING_NAME as BuildingName,\n",
    "                   c.STREET_NAME_NUMBER as StreetNameNumber,\n",
    "                   c.AREA as Area,\n",
    "                   c.CITY_1 as Emirate2,\n",
    "                   c.EXISTING_CUSTOMER as ExistingCustomer,\n",
    "                   c.EMAIL_ADDRESS as EmailAddress,\n",
    "                   c.TELEPHONE_NO as PhoneMobile\n",
    "                   from final_1 f\n",
    "                   left join lead_report_tab l on f.LEAD_ID_E == l.LEAD_ID_L\n",
    "                   left join ft_customer_attributes c on f.customer_id_S == c.customer_id_C\n",
    "                   \"\"\")\n",
    "#df_final.createOrReplaceTempView('final')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "485ef041-be06-4bd6-93dd-38068ceb75d9",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "\n",
    "df_final=df_final.filter(\"!IsNull(EnquiryNo) and !IsNull(EnquiryCreated) and !IsNull(EnquiryType)\")\n",
    "#df_final=df_final.filter(\"ENQUIRY_NUMBER_S != '334095' and ENQUIRY_NUMBER_S != '412601'\")\n",
    "df_final=df_final.withColumn('RowLastUpdated',lit(''))\n",
    "df_final=df_final.withColumn('SourceType',lit('SAP'))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "00b328e0-5cd5-4e81-b21e-031b88ecc7f6",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final=df_final.na.fill(value=0)\n",
    "df_final=df_final.na.fill(\"\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "fefd122e-4f45-48d4-ad64-aab1e07969e8",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "reg_exp=\"\\\\s+\"\n",
    "for colname in df_final.columns:\n",
    "  data_type_list=df_final.select(colname).dtypes[0][1]\n",
    "  if data_type_list=='string':\n",
    "    df_final = df_final.withColumn(colname,trim(regexp_replace(col(colname), reg_exp,\" \")))\n",
    "    df_final = df_final.withColumn(colname,regexp_replace(col(colname),'\\n|\\t',\"\"))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "0338ac32-dfd0-49a4-9779-7ccfe86326e6",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "NULL_COLUMN_LIST=['RowLastUpdated','FirstOrderedPAPrint','HybrisCampaign','1stContact','HUBSubmit','1stApprovedStatus','Invoiced','WayNumber','PC','NearestLandmark','Employer','Salary','LostTo','BankingWith','Leadtatus','ArabicForename','EnglishSurname','ArabicSurname','ArabicComment','UniqueLead','AssignedToSalesExecDate','CloseReasonDescription','ManagementNextActionDate','LastManagementActionDate','FirstManagementNotes','Campaign','Content']\n",
    "for J in NULL_COLUMN_LIST:\n",
    "    df_final=df_final.withColumn(J,lit(None))\n",
    "    \n",
    "# ,'1stVisit',,'Source'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "91e0a3fe-68f7-497b-8136-e39a27f5768a",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "FORMAT_CHANGE_List=['Demo','ReturntoEnquiry','Locator','Offer','PurchaseAgreement','1stOrder','CreateSalesOrder','AppointmentDate','DateCreated','AppraisalCompleted','TI1stValued','TILastValued','TIAllowanceSet','TIRemoved','PassToBranchDate','DOB','FirstOrderedPAPrint','DateCreated']\n",
    "# print(List[0])\n",
    "# '1stVisit',,'1stContact',FirstOrderedDate,"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "b6af69b4-1ee5-4772-a275-fcf1a0bd6314",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "for f in FORMAT_CHANGE_List:\n",
    "    df_final=df_final.withColumn(f,regexp_replace(col(f), \"-\", \"\"))\n",
    "    df_final=df_final.withColumn(f,when(col(f).isNull(),lit(''))\n",
    "                                   .when((col(f)=='0') | (col(f)=='00') | (col(f) == '') | (col(f) == '00000000'),lit(''))\n",
    "                                   .otherwise(concat(substring(col(f),1,4),lit('-'),substring(col(f),5,2),lit('-'),substring(col(f),7,2),lit(' 00:00:00'))))\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "441951c1-53d0-48bf-95a8-36422e931dd7",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "FORMAT_CHANGE_List_2=['Invoiced','FirstOrdered','TestDrivePrint','LastStatusUpdate','FirstVisit','LastVisit','FirstActionDate','ActDeliveryDate','ExpDeliveryDate','LeadCreated','ClosedDate','ReceivedDate','ReviewedDate','AssignedToSalesExecDate','NextActionDate','FirstManagementActionDate','ManagementNextActionDate','EnquiryCreated','LastManagementActionDate']"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "c88b2c8a-78a7-4dfd-a479-053a3c0d2cd6",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "for i in FORMAT_CHANGE_List_2:\n",
    "    df_final=df_final.withColumn(i,regexp_replace(col(i), \"-\", \"\"))\n",
    "    df_final=df_final.withColumn(i,when(col(i).isNull(),lit(''))\n",
    "                                   .when((col(i)=='0') | (col(i)=='00') | (col(i) == '') | (col(i) == '00000000'),lit(''))\n",
    "                                   .otherwise(concat(substring(col(i),1,4),lit('-'),substring(col(i),5,2),lit('-'),substring(col(i),7,2),lit(' '),substring(col(i),9,2),lit(':'),substring(col(i),11,2),lit(':'),substring(col(i),13,2))))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "46ff4440-c6f6-4e7d-9ef1-59b56dd07f61",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "FORMAT_CHANGE_List_3=['Delivered']"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "7507e5e2-f622-4326-8076-fb9d3512cab7",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "for i in FORMAT_CHANGE_List_3:\n",
    "    df_final=df_final.withColumn(i,regexp_replace(col(i), \"-\", \"\"))\n",
    "    df_final=df_final.withColumn(i,when(col(i).isNull(),lit(''))\n",
    "                                   .when((col(i)=='0') | (col(i)=='00') | (col(i) == '') | (col(i) == '00000000'),lit(''))\n",
    "                                   .when(length(col(i))==8,concat(substring(col(i),1,4),lit('-'),substring(col(i),5,2),lit('-'),substring(col(i),7,2),lit(' 00:00:00')))\n",
    "                                   .otherwise(concat(substring(col(i),1,4),lit('-'),substring(col(i),5,2),lit('-'),substring(col(i),7,2),lit(' '),substring(col(i),9,2),lit(':'),substring(col(i),11,2),lit(':'),substring(col(i),13,2))))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "5804df50-077a-4740-966a-69a7df9efd5c",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final=df_final.withColumn('1stVisit',col('FirstVisit')).withColumn('Source',col('LeadType')).withColumn('Emirate2',col('Emirate'))\n",
    "df_final=df_final.withColumn('1stOrder',col('FirstOrdered'))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "4b01d3d5-5de9-4982-a6e0-ea71d87c0a73",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final=df_final.withColumn('LeadChannel',when(substring(col('LeadType'),1,3) == 'Web',lit('Web'))\n",
    "                                           .when(substring(col('LeadType'),1,3) == 'Tel',lit('Telephone'))\n",
    "                                           .when(substring(col('LeadType'),1,3) == 'Sho',lit('Showroom')).otherwise(lit(None)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "4a046749-276c-4441-8b79-6592b3bea4fd",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final=df_final.withColumn('EnquiryType',when((col('EnquiryType') == 'Showroom') | (col('EnquiryType') == 'Walk-In'),lit('Showroom/Walk-In'))\n",
    "                                           .otherwise((col('EnquiryType'))))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "39105f3d-96de-4f30-b4ca-b513d0fa0979",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final=df_final.withColumn('TradeInFlag',when((col('TradeInFlag') == '') | (col('TradeInFlag') == 'No') |  col('TradeInFlag').isNull(),lit('N')).otherwise((lit('Y'))))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "3e97ad84-c767-429c-a0d7-afaa819e37a4",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final=df_final.withColumn('AppointmentStatusName',initcap(col('AppointmentStatusName'))).withColumn('Franchise',initcap(col('Franchise')))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "047c01d8-0954-492a-9314-66f79ba2e937",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final=df_final.withColumn('EIDNumber',when((col('EIDNumber') == '0'),lit(None)).otherwise(col('EIDNumber')))\n",
    "df_final=df_final.withColumn('EmailAddress',when((col('EmailAddress')).isNull() | (col('EmailAddress') == ''),lit('No')).otherwise(lit('Yes')))\n",
    "\n",
    "df_final=df_final.withColumn('PhoneMobile',when((col('PhoneMobile')).isNull() | (col('PhoneMobile') == ''),lit('No')).otherwise(lit('Yes')))\n",
    "# df_final=df_final.withColumn('PhoneMobile',when((col('PhoneMobile')).isNotNull(),lit('Yes')).otherwise(lit('No')))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "e9a828dc-2abb-44a4-bd23-a92c83bac014",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final=df_final.withColumn('CREATE_SALES_ORDER_TIME',concat(substring(col('CREATE_SALES_ORDER_TIME'),1,2),lit(':'),substring(col('CREATE_SALES_ORDER_TIME'),3,2),lit(':'),substring(col('CREATE_SALES_ORDER_TIME'),5,2)))\n",
    "\n",
    "\n",
    "df_final=df_final.withColumn('CreateSalesOrder',concat(substring(col('CreateSalesOrder'),1,10),lit(' '),col('CREATE_SALES_ORDER_TIME')))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "63eb10a6-de1c-4adb-a307-970e8f735b2f",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final=df_final.select('RowLastUpdated','EnquiryNo','Branch','EnquiryCreated','EnquiryType','LeadCreated','LeadType','SourceOfEnquiry','FirstVisit','LastVisit','Demo','FirstOrderedPAPrint','Status','LastStatusUpdate','SAPOrderNumber','NewUsed','SalesExec','Customer','EIDNumber','Make','Model','Derivative','Variant','ArticleCode','VariantCode','HybrisCampaign','ExpDeliveryDate','ActDeliveryDate','SalesType','FirstOrdered','VIN_No-VIN_Current','DateCreated','AppraisalCompleted','TI1stValue','TI1stValued','TILastValue','TILastValued','TILastValueUser','TIAllowance','TIAllowanceSet','TIAllowanceUserName','TIRemoved','TIRemovedUser','1stOrder','TI1stValueUser','BusinessManager','1stContact','1stVisit','CashFinance','TestDrivePrint','ReturntoEnquiry','Locator','Offer','CreateSalesOrder','DownPayment','PurchaseAgreement','HUBSubmit','1stApprovedStatus','Invoiced','Delivered','Franchise','Gender','Nationality','DOB','POBox','Emirate','FlatVillaNo','WayNumber','BuildingName','StreetNameNumber','Area','Emirate2','PC','NearestLandmark','VehicleofInterest','Employer','Salary','LostTo','LostReason','BankingWith','ReceivedDate','LeadChannel','LeadSource','Leadtatus','LanguageName','EnglishForename','ArabicForename','EnglishSurname','ArabicSurname','EmailAddress','PhoneMobile','EnglishMake','ArabicMake','EnglishModel','ArabicModel','EnglishComment','ArabicComment','ExistingCustomer','UniqueLead','ReviewedUser','ReviewedDate','PassToBranchUser','PassToBranchDate','AssignedToSalesExecDate','AppointmentDate','AppointmentStatusName','DemoTaken','CloseReasonDescription','ClosedDate','BDCNextAction','NextActionDate','FirstManagementActionDate','ManagementNextActionDate','LastManagementActionDate','FirstManagementNotes','LastManagementNotes','FirstActionDate','ManualLead','ManualLeadCreatedBy','LeadURL','Medium','Source','Campaign','Content','KeywordsTerm','SessionCount','PageViewCount','ClientID','BeBacks','CurrentMake','CurrentModel','TradeInFlag','ApptCount','ApptShows','Customer_ID_Connect','SourceType','BranchId','TradeInMatFlg','TradeIn_VIN','REJ_REASON','TRPOVAL','TRSTATUSDD','REJ_REASON_TR','AEDAT','BLDAT')\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "8ee5f78c-a27d-4b5b-85c6-01b3f3f6a13b",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\"></div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\"></div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_final.createOrReplaceTempView('vw_final_format')\n",
    "df_final_format= spark.sql(\"\"\"select *,Cast((Cast(EnquiryCreated as timestamp) + Interval '4' hour) as string) as EnqDateNew from vw_final_format\"\"\")\n",
    "df_final_format=df_final_format.drop('EnquiryCreated') \n",
    "df_final_format= df_final_format.withColumnRenamed('EnqDateNew','EnquiryCreated')\n",
    "df_final_format.createOrReplaceTempView('df_final_format')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "6a765414-74cc-4c7e-bea1-8db3086bfe53",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\">UPDATE SET `RowLastUpdated`=SOURCE.`RowLastUpdated`,`EnquiryNo`=SOURCE.`EnquiryNo`,`Branch`=SOURCE.`Branch`,`EnquiryType`=SOURCE.`EnquiryType`,`LeadCreated`=SOURCE.`LeadCreated`,`LeadType`=SOURCE.`LeadType`,`SourceOfEnquiry`=SOURCE.`SourceOfEnquiry`,`FirstVisit`=SOURCE.`FirstVisit`,`LastVisit`=SOURCE.`LastVisit`,`Demo`=SOURCE.`Demo`,`FirstOrderedPAPrint`=SOURCE.`FirstOrderedPAPrint`,`Status`=SOURCE.`Status`,`LastStatusUpdate`=SOURCE.`LastStatusUpdate`,`SAPOrderNumber`=SOURCE.`SAPOrderNumber`,`NewUsed`=SOURCE.`NewUsed`,`SalesExec`=SOURCE.`SalesExec`,`Customer`=SOURCE.`Customer`,`EIDNumber`=SOURCE.`EIDNumber`,`Make`=SOURCE.`Make`,`Model`=SOURCE.`Model`,`Derivative`=SOURCE.`Derivative`,`Variant`=SOURCE.`Variant`,`ArticleCode`=SOURCE.`ArticleCode`,`VariantCode`=SOURCE.`VariantCode`,`HybrisCampaign`=SOURCE.`HybrisCampaign`,`ExpDeliveryDate`=SOURCE.`ExpDeliveryDate`,`ActDeliveryDate`=SOURCE.`ActDeliveryDate`,`SalesType`=SOURCE.`SalesType`,`FirstOrdered`=SOURCE.`FirstOrdered`,`VIN_No-VIN_Current`=SOURCE.`VIN_No-VIN_Current`,`DateCreated`=SOURCE.`DateCreated`,`AppraisalCompleted`=SOURCE.`AppraisalCompleted`,`TI1stValue`=SOURCE.`TI1stValue`,`TI1stValued`=SOURCE.`TI1stValued`,`TILastValue`=SOURCE.`TILastValue`,`TILastValued`=SOURCE.`TILastValued`,`TILastValueUser`=SOURCE.`TILastValueUser`,`TIAllowance`=SOURCE.`TIAllowance`,`TIAllowanceSet`=SOURCE.`TIAllowanceSet`,`TIAllowanceUserName`=SOURCE.`TIAllowanceUserName`,`TIRemoved`=SOURCE.`TIRemoved`,`TIRemovedUser`=SOURCE.`TIRemovedUser`,`1stOrder`=SOURCE.`1stOrder`,`TI1stValueUser`=SOURCE.`TI1stValueUser`,`BusinessManager`=SOURCE.`BusinessManager`,`1stContact`=SOURCE.`1stContact`,`1stVisit`=SOURCE.`1stVisit`,`CashFinance`=SOURCE.`CashFinance`,`TestDrivePrint`=SOURCE.`TestDrivePrint`,`ReturntoEnquiry`=SOURCE.`ReturntoEnquiry`,`Locator`=SOURCE.`Locator`,`Offer`=SOURCE.`Offer`,`CreateSalesOrder`=SOURCE.`CreateSalesOrder`,`DownPayment`=SOURCE.`DownPayment`,`PurchaseAgreement`=SOURCE.`PurchaseAgreement`,`HUBSubmit`=SOURCE.`HUBSubmit`,`1stApprovedStatus`=SOURCE.`1stApprovedStatus`,`Invoiced`=SOURCE.`Invoiced`,`Delivered`=SOURCE.`Delivered`,`Franchise`=SOURCE.`Franchise`,`Gender`=SOURCE.`Gender`,`Nationality`=SOURCE.`Nationality`,`DOB`=SOURCE.`DOB`,`POBox`=SOURCE.`POBox`,`Emirate`=SOURCE.`Emirate`,`FlatVillaNo`=SOURCE.`FlatVillaNo`,`WayNumber`=SOURCE.`WayNumber`,`BuildingName`=SOURCE.`BuildingName`,`StreetNameNumber`=SOURCE.`StreetNameNumber`,`Area`=SOURCE.`Area`,`Emirate2`=SOURCE.`Emirate2`,`PC`=SOURCE.`PC`,`NearestLandmark`=SOURCE.`NearestLandmark`,`VehicleofInterest`=SOURCE.`VehicleofInterest`,`Employer`=SOURCE.`Employer`,`Salary`=SOURCE.`Salary`,`LostTo`=SOURCE.`LostTo`,`LostReason`=SOURCE.`LostReason`,`BankingWith`=SOURCE.`BankingWith`,`ReceivedDate`=SOURCE.`ReceivedDate`,`LeadChannel`=SOURCE.`LeadChannel`,`LeadSource`=SOURCE.`LeadSource`,`Leadtatus`=SOURCE.`Leadtatus`,`LanguageName`=SOURCE.`LanguageName`,`EnglishForename`=SOURCE.`EnglishForename`,`ArabicForename`=SOURCE.`ArabicForename`,`EnglishSurname`=SOURCE.`EnglishSurname`,`ArabicSurname`=SOURCE.`ArabicSurname`,`EmailAddress`=SOURCE.`EmailAddress`,`PhoneMobile`=SOURCE.`PhoneMobile`,`EnglishMake`=SOURCE.`EnglishMake`,`ArabicMake`=SOURCE.`ArabicMake`,`EnglishModel`=SOURCE.`EnglishModel`,`ArabicModel`=SOURCE.`ArabicModel`,`EnglishComment`=SOURCE.`EnglishComment`,`ArabicComment`=SOURCE.`ArabicComment`,`ExistingCustomer`=SOURCE.`ExistingCustomer`,`UniqueLead`=SOURCE.`UniqueLead`,`ReviewedUser`=SOURCE.`ReviewedUser`,`ReviewedDate`=SOURCE.`ReviewedDate`,`PassToBranchUser`=SOURCE.`PassToBranchUser`,`PassToBranchDate`=SOURCE.`PassToBranchDate`,`AssignedToSalesExecDate`=SOURCE.`AssignedToSalesExecDate`,`AppointmentDate`=SOURCE.`AppointmentDate`,`AppointmentStatusName`=SOURCE.`AppointmentStatusName`,`DemoTaken`=SOURCE.`DemoTaken`,`CloseReasonDescription`=SOURCE.`CloseReasonDescription`,`ClosedDate`=SOURCE.`ClosedDate`,`BDCNextAction`=SOURCE.`BDCNextAction`,`NextActionDate`=SOURCE.`NextActionDate`,`FirstManagementActionDate`=SOURCE.`FirstManagementActionDate`,`ManagementNextActionDate`=SOURCE.`ManagementNextActionDate`,`LastManagementActionDate`=SOURCE.`LastManagementActionDate`,`FirstManagementNotes`=SOURCE.`FirstManagementNotes`,`LastManagementNotes`=SOURCE.`LastManagementNotes`,`FirstActionDate`=SOURCE.`FirstActionDate`,`ManualLead`=SOURCE.`ManualLead`,`ManualLeadCreatedBy`=SOURCE.`ManualLeadCreatedBy`,`LeadURL`=SOURCE.`LeadURL`,`Medium`=SOURCE.`Medium`,`Source`=SOURCE.`Source`,`Campaign`=SOURCE.`Campaign`,`Content`=SOURCE.`Content`,`KeywordsTerm`=SOURCE.`KeywordsTerm`,`SessionCount`=SOURCE.`SessionCount`,`PageViewCount`=SOURCE.`PageViewCount`,`ClientID`=SOURCE.`ClientID`,`BeBacks`=SOURCE.`BeBacks`,`CurrentMake`=SOURCE.`CurrentMake`,`CurrentModel`=SOURCE.`CurrentModel`,`TradeInFlag`=SOURCE.`TradeInFlag`,`ApptCount`=SOURCE.`ApptCount`,`ApptShows`=SOURCE.`ApptShows`,`Customer_ID_Connect`=SOURCE.`Customer_ID_Connect`,`SourceType`=SOURCE.`SourceType`,`BranchId`=SOURCE.`BranchId`,`TradeInMatFlg`=SOURCE.`TradeInMatFlg`,`TradeIn_VIN`=SOURCE.`TradeIn_VIN`,`REJ_REASON`=SOURCE.`REJ_REASON`,`TRPOVAL`=SOURCE.`TRPOVAL`,`TRSTATUSDD`=SOURCE.`TRSTATUSDD`,`REJ_REASON_TR`=SOURCE.`REJ_REASON_TR`,`AEDAT`=SOURCE.`AEDAT`,`BLDAT`=SOURCE.`BLDAT`,`EnquiryCreated`=SOURCE.`EnquiryCreated` ,LOAD_DATE = current_date()\n",
       "</div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\">UPDATE SET `RowLastUpdated`=SOURCE.`RowLastUpdated`,`EnquiryNo`=SOURCE.`EnquiryNo`,`Branch`=SOURCE.`Branch`,`EnquiryType`=SOURCE.`EnquiryType`,`LeadCreated`=SOURCE.`LeadCreated`,`LeadType`=SOURCE.`LeadType`,`SourceOfEnquiry`=SOURCE.`SourceOfEnquiry`,`FirstVisit`=SOURCE.`FirstVisit`,`LastVisit`=SOURCE.`LastVisit`,`Demo`=SOURCE.`Demo`,`FirstOrderedPAPrint`=SOURCE.`FirstOrderedPAPrint`,`Status`=SOURCE.`Status`,`LastStatusUpdate`=SOURCE.`LastStatusUpdate`,`SAPOrderNumber`=SOURCE.`SAPOrderNumber`,`NewUsed`=SOURCE.`NewUsed`,`SalesExec`=SOURCE.`SalesExec`,`Customer`=SOURCE.`Customer`,`EIDNumber`=SOURCE.`EIDNumber`,`Make`=SOURCE.`Make`,`Model`=SOURCE.`Model`,`Derivative`=SOURCE.`Derivative`,`Variant`=SOURCE.`Variant`,`ArticleCode`=SOURCE.`ArticleCode`,`VariantCode`=SOURCE.`VariantCode`,`HybrisCampaign`=SOURCE.`HybrisCampaign`,`ExpDeliveryDate`=SOURCE.`ExpDeliveryDate`,`ActDeliveryDate`=SOURCE.`ActDeliveryDate`,`SalesType`=SOURCE.`SalesType`,`FirstOrdered`=SOURCE.`FirstOrdered`,`VIN_No-VIN_Current`=SOURCE.`VIN_No-VIN_Current`,`DateCreated`=SOURCE.`DateCreated`,`AppraisalCompleted`=SOURCE.`AppraisalCompleted`,`TI1stValue`=SOURCE.`TI1stValue`,`TI1stValued`=SOURCE.`TI1stValued`,`TILastValue`=SOURCE.`TILastValue`,`TILastValued`=SOURCE.`TILastValued`,`TILastValueUser`=SOURCE.`TILastValueUser`,`TIAllowance`=SOURCE.`TIAllowance`,`TIAllowanceSet`=SOURCE.`TIAllowanceSet`,`TIAllowanceUserName`=SOURCE.`TIAllowanceUserName`,`TIRemoved`=SOURCE.`TIRemoved`,`TIRemovedUser`=SOURCE.`TIRemovedUser`,`1stOrder`=SOURCE.`1stOrder`,`TI1stValueUser`=SOURCE.`TI1stValueUser`,`BusinessManager`=SOURCE.`BusinessManager`,`1stContact`=SOURCE.`1stContact`,`1stVisit`=SOURCE.`1stVisit`,`CashFinance`=SOURCE.`CashFinance`,`TestDrivePrint`=SOURCE.`TestDrivePrint`,`ReturntoEnquiry`=SOURCE.`ReturntoEnquiry`,`Locator`=SOURCE.`Locator`,`Offer`=SOURCE.`Offer`,`CreateSalesOrder`=SOURCE.`CreateSalesOrder`,`DownPayment`=SOURCE.`DownPayment`,`PurchaseAgreement`=SOURCE.`PurchaseAgreement`,`HUBSubmit`=SOURCE.`HUBSubmit`,`1stApprovedStatus`=SOURCE.`1stApprovedStatus`,`Invoiced`=SOURCE.`Invoiced`,`Delivered`=SOURCE.`Delivered`,`Franchise`=SOURCE.`Franchise`,`Gender`=SOURCE.`Gender`,`Nationality`=SOURCE.`Nationality`,`DOB`=SOURCE.`DOB`,`POBox`=SOURCE.`POBox`,`Emirate`=SOURCE.`Emirate`,`FlatVillaNo`=SOURCE.`FlatVillaNo`,`WayNumber`=SOURCE.`WayNumber`,`BuildingName`=SOURCE.`BuildingName`,`StreetNameNumber`=SOURCE.`StreetNameNumber`,`Area`=SOURCE.`Area`,`Emirate2`=SOURCE.`Emirate2`,`PC`=SOURCE.`PC`,`NearestLandmark`=SOURCE.`NearestLandmark`,`VehicleofInterest`=SOURCE.`VehicleofInterest`,`Employer`=SOURCE.`Employer`,`Salary`=SOURCE.`Salary`,`LostTo`=SOURCE.`LostTo`,`LostReason`=SOURCE.`LostReason`,`BankingWith`=SOURCE.`BankingWith`,`ReceivedDate`=SOURCE.`ReceivedDate`,`LeadChannel`=SOURCE.`LeadChannel`,`LeadSource`=SOURCE.`LeadSource`,`Leadtatus`=SOURCE.`Leadtatus`,`LanguageName`=SOURCE.`LanguageName`,`EnglishForename`=SOURCE.`EnglishForename`,`ArabicForename`=SOURCE.`ArabicForename`,`EnglishSurname`=SOURCE.`EnglishSurname`,`ArabicSurname`=SOURCE.`ArabicSurname`,`EmailAddress`=SOURCE.`EmailAddress`,`PhoneMobile`=SOURCE.`PhoneMobile`,`EnglishMake`=SOURCE.`EnglishMake`,`ArabicMake`=SOURCE.`ArabicMake`,`EnglishModel`=SOURCE.`EnglishModel`,`ArabicModel`=SOURCE.`ArabicModel`,`EnglishComment`=SOURCE.`EnglishComment`,`ArabicComment`=SOURCE.`ArabicComment`,`ExistingCustomer`=SOURCE.`ExistingCustomer`,`UniqueLead`=SOURCE.`UniqueLead`,`ReviewedUser`=SOURCE.`ReviewedUser`,`ReviewedDate`=SOURCE.`ReviewedDate`,`PassToBranchUser`=SOURCE.`PassToBranchUser`,`PassToBranchDate`=SOURCE.`PassToBranchDate`,`AssignedToSalesExecDate`=SOURCE.`AssignedToSalesExecDate`,`AppointmentDate`=SOURCE.`AppointmentDate`,`AppointmentStatusName`=SOURCE.`AppointmentStatusName`,`DemoTaken`=SOURCE.`DemoTaken`,`CloseReasonDescription`=SOURCE.`CloseReasonDescription`,`ClosedDate`=SOURCE.`ClosedDate`,`BDCNextAction`=SOURCE.`BDCNextAction`,`NextActionDate`=SOURCE.`NextActionDate`,`FirstManagementActionDate`=SOURCE.`FirstManagementActionDate`,`ManagementNextActionDate`=SOURCE.`ManagementNextActionDate`,`LastManagementActionDate`=SOURCE.`LastManagementActionDate`,`FirstManagementNotes`=SOURCE.`FirstManagementNotes`,`LastManagementNotes`=SOURCE.`LastManagementNotes`,`FirstActionDate`=SOURCE.`FirstActionDate`,`ManualLead`=SOURCE.`ManualLead`,`ManualLeadCreatedBy`=SOURCE.`ManualLeadCreatedBy`,`LeadURL`=SOURCE.`LeadURL`,`Medium`=SOURCE.`Medium`,`Source`=SOURCE.`Source`,`Campaign`=SOURCE.`Campaign`,`Content`=SOURCE.`Content`,`KeywordsTerm`=SOURCE.`KeywordsTerm`,`SessionCount`=SOURCE.`SessionCount`,`PageViewCount`=SOURCE.`PageViewCount`,`ClientID`=SOURCE.`ClientID`,`BeBacks`=SOURCE.`BeBacks`,`CurrentMake`=SOURCE.`CurrentMake`,`CurrentModel`=SOURCE.`CurrentModel`,`TradeInFlag`=SOURCE.`TradeInFlag`,`ApptCount`=SOURCE.`ApptCount`,`ApptShows`=SOURCE.`ApptShows`,`Customer_ID_Connect`=SOURCE.`Customer_ID_Connect`,`SourceType`=SOURCE.`SourceType`,`BranchId`=SOURCE.`BranchId`,`TradeInMatFlg`=SOURCE.`TradeInMatFlg`,`TradeIn_VIN`=SOURCE.`TradeIn_VIN`,`REJ_REASON`=SOURCE.`REJ_REASON`,`TRPOVAL`=SOURCE.`TRPOVAL`,`TRSTATUSDD`=SOURCE.`TRSTATUSDD`,`REJ_REASON_TR`=SOURCE.`REJ_REASON_TR`,`AEDAT`=SOURCE.`AEDAT`,`BLDAT`=SOURCE.`BLDAT`,`EnquiryCreated`=SOURCE.`EnquiryCreated` ,LOAD_DATE = current_date()\n</div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "update_sub_statement = ','.join(spark.sparkContext.parallelize(df_final_format.columns).map(lambda x: '`'+x+'`'+'=SOURCE.'+'`'+x+'`').collect())\n",
    "final_update_statement='UPDATE SET ' + update_sub_statement\n",
    "\n",
    "final_update_statement=final_update_statement + \" ,LOAD_DATE = current_date()\"\n",
    "\n",
    "print(final_update_statement)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "cbc7069b-4826-484d-bb7f-7f35a5a771ec",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\">INSERT (`RowLastUpdated`,`EnquiryNo`,`Branch`,`EnquiryType`,`LeadCreated`,`LeadType`,`SourceOfEnquiry`,`FirstVisit`,`LastVisit`,`Demo`,`FirstOrderedPAPrint`,`Status`,`LastStatusUpdate`,`SAPOrderNumber`,`NewUsed`,`SalesExec`,`Customer`,`EIDNumber`,`Make`,`Model`,`Derivative`,`Variant`,`ArticleCode`,`VariantCode`,`HybrisCampaign`,`ExpDeliveryDate`,`ActDeliveryDate`,`SalesType`,`FirstOrdered`,`VIN_No-VIN_Current`,`DateCreated`,`AppraisalCompleted`,`TI1stValue`,`TI1stValued`,`TILastValue`,`TILastValued`,`TILastValueUser`,`TIAllowance`,`TIAllowanceSet`,`TIAllowanceUserName`,`TIRemoved`,`TIRemovedUser`,`1stOrder`,`TI1stValueUser`,`BusinessManager`,`1stContact`,`1stVisit`,`CashFinance`,`TestDrivePrint`,`ReturntoEnquiry`,`Locator`,`Offer`,`CreateSalesOrder`,`DownPayment`,`PurchaseAgreement`,`HUBSubmit`,`1stApprovedStatus`,`Invoiced`,`Delivered`,`Franchise`,`Gender`,`Nationality`,`DOB`,`POBox`,`Emirate`,`FlatVillaNo`,`WayNumber`,`BuildingName`,`StreetNameNumber`,`Area`,`Emirate2`,`PC`,`NearestLandmark`,`VehicleofInterest`,`Employer`,`Salary`,`LostTo`,`LostReason`,`BankingWith`,`ReceivedDate`,`LeadChannel`,`LeadSource`,`Leadtatus`,`LanguageName`,`EnglishForename`,`ArabicForename`,`EnglishSurname`,`ArabicSurname`,`EmailAddress`,`PhoneMobile`,`EnglishMake`,`ArabicMake`,`EnglishModel`,`ArabicModel`,`EnglishComment`,`ArabicComment`,`ExistingCustomer`,`UniqueLead`,`ReviewedUser`,`ReviewedDate`,`PassToBranchUser`,`PassToBranchDate`,`AssignedToSalesExecDate`,`AppointmentDate`,`AppointmentStatusName`,`DemoTaken`,`CloseReasonDescription`,`ClosedDate`,`BDCNextAction`,`NextActionDate`,`FirstManagementActionDate`,`ManagementNextActionDate`,`LastManagementActionDate`,`FirstManagementNotes`,`LastManagementNotes`,`FirstActionDate`,`ManualLead`,`ManualLeadCreatedBy`,`LeadURL`,`Medium`,`Source`,`Campaign`,`Content`,`KeywordsTerm`,`SessionCount`,`PageViewCount`,`ClientID`,`BeBacks`,`CurrentMake`,`CurrentModel`,`TradeInFlag`,`ApptCount`,`ApptShows`,`Customer_ID_Connect`,`SourceType`,`BranchId`,`TradeInMatFlg`,`TradeIn_VIN`,`REJ_REASON`,`TRPOVAL`,`TRSTATUSDD`,`REJ_REASON_TR`,`AEDAT`,`BLDAT`,`EnquiryCreated`,LOAD_DATE) VALUES(SOURCE.`RowLastUpdated`,SOURCE.`EnquiryNo`,SOURCE.`Branch`,SOURCE.`EnquiryType`,SOURCE.`LeadCreated`,SOURCE.`LeadType`,SOURCE.`SourceOfEnquiry`,SOURCE.`FirstVisit`,SOURCE.`LastVisit`,SOURCE.`Demo`,SOURCE.`FirstOrderedPAPrint`,SOURCE.`Status`,SOURCE.`LastStatusUpdate`,SOURCE.`SAPOrderNumber`,SOURCE.`NewUsed`,SOURCE.`SalesExec`,SOURCE.`Customer`,SOURCE.`EIDNumber`,SOURCE.`Make`,SOURCE.`Model`,SOURCE.`Derivative`,SOURCE.`Variant`,SOURCE.`ArticleCode`,SOURCE.`VariantCode`,SOURCE.`HybrisCampaign`,SOURCE.`ExpDeliveryDate`,SOURCE.`ActDeliveryDate`,SOURCE.`SalesType`,SOURCE.`FirstOrdered`,SOURCE.`VIN_No-VIN_Current`,SOURCE.`DateCreated`,SOURCE.`AppraisalCompleted`,SOURCE.`TI1stValue`,SOURCE.`TI1stValued`,SOURCE.`TILastValue`,SOURCE.`TILastValued`,SOURCE.`TILastValueUser`,SOURCE.`TIAllowance`,SOURCE.`TIAllowanceSet`,SOURCE.`TIAllowanceUserName`,SOURCE.`TIRemoved`,SOURCE.`TIRemovedUser`,SOURCE.`1stOrder`,SOURCE.`TI1stValueUser`,SOURCE.`BusinessManager`,SOURCE.`1stContact`,SOURCE.`1stVisit`,SOURCE.`CashFinance`,SOURCE.`TestDrivePrint`,SOURCE.`ReturntoEnquiry`,SOURCE.`Locator`,SOURCE.`Offer`,SOURCE.`CreateSalesOrder`,SOURCE.`DownPayment`,SOURCE.`PurchaseAgreement`,SOURCE.`HUBSubmit`,SOURCE.`1stApprovedStatus`,SOURCE.`Invoiced`,SOURCE.`Delivered`,SOURCE.`Franchise`,SOURCE.`Gender`,SOURCE.`Nationality`,SOURCE.`DOB`,SOURCE.`POBox`,SOURCE.`Emirate`,SOURCE.`FlatVillaNo`,SOURCE.`WayNumber`,SOURCE.`BuildingName`,SOURCE.`StreetNameNumber`,SOURCE.`Area`,SOURCE.`Emirate2`,SOURCE.`PC`,SOURCE.`NearestLandmark`,SOURCE.`VehicleofInterest`,SOURCE.`Employer`,SOURCE.`Salary`,SOURCE.`LostTo`,SOURCE.`LostReason`,SOURCE.`BankingWith`,SOURCE.`ReceivedDate`,SOURCE.`LeadChannel`,SOURCE.`LeadSource`,SOURCE.`Leadtatus`,SOURCE.`LanguageName`,SOURCE.`EnglishForename`,SOURCE.`ArabicForename`,SOURCE.`EnglishSurname`,SOURCE.`ArabicSurname`,SOURCE.`EmailAddress`,SOURCE.`PhoneMobile`,SOURCE.`EnglishMake`,SOURCE.`ArabicMake`,SOURCE.`EnglishModel`,SOURCE.`ArabicModel`,SOURCE.`EnglishComment`,SOURCE.`ArabicComment`,SOURCE.`ExistingCustomer`,SOURCE.`UniqueLead`,SOURCE.`ReviewedUser`,SOURCE.`ReviewedDate`,SOURCE.`PassToBranchUser`,SOURCE.`PassToBranchDate`,SOURCE.`AssignedToSalesExecDate`,SOURCE.`AppointmentDate`,SOURCE.`AppointmentStatusName`,SOURCE.`DemoTaken`,SOURCE.`CloseReasonDescription`,SOURCE.`ClosedDate`,SOURCE.`BDCNextAction`,SOURCE.`NextActionDate`,SOURCE.`FirstManagementActionDate`,SOURCE.`ManagementNextActionDate`,SOURCE.`LastManagementActionDate`,SOURCE.`FirstManagementNotes`,SOURCE.`LastManagementNotes`,SOURCE.`FirstActionDate`,SOURCE.`ManualLead`,SOURCE.`ManualLeadCreatedBy`,SOURCE.`LeadURL`,SOURCE.`Medium`,SOURCE.`Source`,SOURCE.`Campaign`,SOURCE.`Content`,SOURCE.`KeywordsTerm`,SOURCE.`SessionCount`,SOURCE.`PageViewCount`,SOURCE.`ClientID`,SOURCE.`BeBacks`,SOURCE.`CurrentMake`,SOURCE.`CurrentModel`,SOURCE.`TradeInFlag`,SOURCE.`ApptCount`,SOURCE.`ApptShows`,SOURCE.`Customer_ID_Connect`,SOURCE.`SourceType`,SOURCE.`BranchId`,SOURCE.`TradeInMatFlg`,SOURCE.`TradeIn_VIN`,SOURCE.`REJ_REASON`,SOURCE.`TRPOVAL`,SOURCE.`TRSTATUSDD`,SOURCE.`REJ_REASON_TR`,SOURCE.`AEDAT`,SOURCE.`BLDAT`,SOURCE.`EnquiryCreated` , current_date())\n",
       "</div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\">INSERT (`RowLastUpdated`,`EnquiryNo`,`Branch`,`EnquiryType`,`LeadCreated`,`LeadType`,`SourceOfEnquiry`,`FirstVisit`,`LastVisit`,`Demo`,`FirstOrderedPAPrint`,`Status`,`LastStatusUpdate`,`SAPOrderNumber`,`NewUsed`,`SalesExec`,`Customer`,`EIDNumber`,`Make`,`Model`,`Derivative`,`Variant`,`ArticleCode`,`VariantCode`,`HybrisCampaign`,`ExpDeliveryDate`,`ActDeliveryDate`,`SalesType`,`FirstOrdered`,`VIN_No-VIN_Current`,`DateCreated`,`AppraisalCompleted`,`TI1stValue`,`TI1stValued`,`TILastValue`,`TILastValued`,`TILastValueUser`,`TIAllowance`,`TIAllowanceSet`,`TIAllowanceUserName`,`TIRemoved`,`TIRemovedUser`,`1stOrder`,`TI1stValueUser`,`BusinessManager`,`1stContact`,`1stVisit`,`CashFinance`,`TestDrivePrint`,`ReturntoEnquiry`,`Locator`,`Offer`,`CreateSalesOrder`,`DownPayment`,`PurchaseAgreement`,`HUBSubmit`,`1stApprovedStatus`,`Invoiced`,`Delivered`,`Franchise`,`Gender`,`Nationality`,`DOB`,`POBox`,`Emirate`,`FlatVillaNo`,`WayNumber`,`BuildingName`,`StreetNameNumber`,`Area`,`Emirate2`,`PC`,`NearestLandmark`,`VehicleofInterest`,`Employer`,`Salary`,`LostTo`,`LostReason`,`BankingWith`,`ReceivedDate`,`LeadChannel`,`LeadSource`,`Leadtatus`,`LanguageName`,`EnglishForename`,`ArabicForename`,`EnglishSurname`,`ArabicSurname`,`EmailAddress`,`PhoneMobile`,`EnglishMake`,`ArabicMake`,`EnglishModel`,`ArabicModel`,`EnglishComment`,`ArabicComment`,`ExistingCustomer`,`UniqueLead`,`ReviewedUser`,`ReviewedDate`,`PassToBranchUser`,`PassToBranchDate`,`AssignedToSalesExecDate`,`AppointmentDate`,`AppointmentStatusName`,`DemoTaken`,`CloseReasonDescription`,`ClosedDate`,`BDCNextAction`,`NextActionDate`,`FirstManagementActionDate`,`ManagementNextActionDate`,`LastManagementActionDate`,`FirstManagementNotes`,`LastManagementNotes`,`FirstActionDate`,`ManualLead`,`ManualLeadCreatedBy`,`LeadURL`,`Medium`,`Source`,`Campaign`,`Content`,`KeywordsTerm`,`SessionCount`,`PageViewCount`,`ClientID`,`BeBacks`,`CurrentMake`,`CurrentModel`,`TradeInFlag`,`ApptCount`,`ApptShows`,`Customer_ID_Connect`,`SourceType`,`BranchId`,`TradeInMatFlg`,`TradeIn_VIN`,`REJ_REASON`,`TRPOVAL`,`TRSTATUSDD`,`REJ_REASON_TR`,`AEDAT`,`BLDAT`,`EnquiryCreated`,LOAD_DATE) VALUES(SOURCE.`RowLastUpdated`,SOURCE.`EnquiryNo`,SOURCE.`Branch`,SOURCE.`EnquiryType`,SOURCE.`LeadCreated`,SOURCE.`LeadType`,SOURCE.`SourceOfEnquiry`,SOURCE.`FirstVisit`,SOURCE.`LastVisit`,SOURCE.`Demo`,SOURCE.`FirstOrderedPAPrint`,SOURCE.`Status`,SOURCE.`LastStatusUpdate`,SOURCE.`SAPOrderNumber`,SOURCE.`NewUsed`,SOURCE.`SalesExec`,SOURCE.`Customer`,SOURCE.`EIDNumber`,SOURCE.`Make`,SOURCE.`Model`,SOURCE.`Derivative`,SOURCE.`Variant`,SOURCE.`ArticleCode`,SOURCE.`VariantCode`,SOURCE.`HybrisCampaign`,SOURCE.`ExpDeliveryDate`,SOURCE.`ActDeliveryDate`,SOURCE.`SalesType`,SOURCE.`FirstOrdered`,SOURCE.`VIN_No-VIN_Current`,SOURCE.`DateCreated`,SOURCE.`AppraisalCompleted`,SOURCE.`TI1stValue`,SOURCE.`TI1stValued`,SOURCE.`TILastValue`,SOURCE.`TILastValued`,SOURCE.`TILastValueUser`,SOURCE.`TIAllowance`,SOURCE.`TIAllowanceSet`,SOURCE.`TIAllowanceUserName`,SOURCE.`TIRemoved`,SOURCE.`TIRemovedUser`,SOURCE.`1stOrder`,SOURCE.`TI1stValueUser`,SOURCE.`BusinessManager`,SOURCE.`1stContact`,SOURCE.`1stVisit`,SOURCE.`CashFinance`,SOURCE.`TestDrivePrint`,SOURCE.`ReturntoEnquiry`,SOURCE.`Locator`,SOURCE.`Offer`,SOURCE.`CreateSalesOrder`,SOURCE.`DownPayment`,SOURCE.`PurchaseAgreement`,SOURCE.`HUBSubmit`,SOURCE.`1stApprovedStatus`,SOURCE.`Invoiced`,SOURCE.`Delivered`,SOURCE.`Franchise`,SOURCE.`Gender`,SOURCE.`Nationality`,SOURCE.`DOB`,SOURCE.`POBox`,SOURCE.`Emirate`,SOURCE.`FlatVillaNo`,SOURCE.`WayNumber`,SOURCE.`BuildingName`,SOURCE.`StreetNameNumber`,SOURCE.`Area`,SOURCE.`Emirate2`,SOURCE.`PC`,SOURCE.`NearestLandmark`,SOURCE.`VehicleofInterest`,SOURCE.`Employer`,SOURCE.`Salary`,SOURCE.`LostTo`,SOURCE.`LostReason`,SOURCE.`BankingWith`,SOURCE.`ReceivedDate`,SOURCE.`LeadChannel`,SOURCE.`LeadSource`,SOURCE.`Leadtatus`,SOURCE.`LanguageName`,SOURCE.`EnglishForename`,SOURCE.`ArabicForename`,SOURCE.`EnglishSurname`,SOURCE.`ArabicSurname`,SOURCE.`EmailAddress`,SOURCE.`PhoneMobile`,SOURCE.`EnglishMake`,SOURCE.`ArabicMake`,SOURCE.`EnglishModel`,SOURCE.`ArabicModel`,SOURCE.`EnglishComment`,SOURCE.`ArabicComment`,SOURCE.`ExistingCustomer`,SOURCE.`UniqueLead`,SOURCE.`ReviewedUser`,SOURCE.`ReviewedDate`,SOURCE.`PassToBranchUser`,SOURCE.`PassToBranchDate`,SOURCE.`AssignedToSalesExecDate`,SOURCE.`AppointmentDate`,SOURCE.`AppointmentStatusName`,SOURCE.`DemoTaken`,SOURCE.`CloseReasonDescription`,SOURCE.`ClosedDate`,SOURCE.`BDCNextAction`,SOURCE.`NextActionDate`,SOURCE.`FirstManagementActionDate`,SOURCE.`ManagementNextActionDate`,SOURCE.`LastManagementActionDate`,SOURCE.`FirstManagementNotes`,SOURCE.`LastManagementNotes`,SOURCE.`FirstActionDate`,SOURCE.`ManualLead`,SOURCE.`ManualLeadCreatedBy`,SOURCE.`LeadURL`,SOURCE.`Medium`,SOURCE.`Source`,SOURCE.`Campaign`,SOURCE.`Content`,SOURCE.`KeywordsTerm`,SOURCE.`SessionCount`,SOURCE.`PageViewCount`,SOURCE.`ClientID`,SOURCE.`BeBacks`,SOURCE.`CurrentMake`,SOURCE.`CurrentModel`,SOURCE.`TradeInFlag`,SOURCE.`ApptCount`,SOURCE.`ApptShows`,SOURCE.`Customer_ID_Connect`,SOURCE.`SourceType`,SOURCE.`BranchId`,SOURCE.`TradeInMatFlg`,SOURCE.`TradeIn_VIN`,SOURCE.`REJ_REASON`,SOURCE.`TRPOVAL`,SOURCE.`TRSTATUSDD`,SOURCE.`REJ_REASON_TR`,SOURCE.`AEDAT`,SOURCE.`BLDAT`,SOURCE.`EnquiryCreated` , current_date())\n</div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "insert_sub_statement = ','.join(spark.sparkContext.parallelize(df_final_format.columns).map(lambda x:'SOURCE.'+'`'+x+'`').collect())\n",
    "columns_statement = ','.join(spark.sparkContext.parallelize(df_final_format.columns).map(lambda x:'`'+x+'`').collect())\n",
    "\n",
    "insert_sub_statement=insert_sub_statement+ \" , current_date()\"\n",
    "\n",
    "final_insert_statement='INSERT (' + columns_statement +',LOAD_DATE) VALUES(' + insert_sub_statement+')'\n",
    "print(final_insert_statement)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "e784b235-a50a-48ad-963d-8db47db7e4ea",
     "showTitle": false,
     "title": ""
    }
   },
   "source": [
    "# Creating Final Merge Statement"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "037168b1-46ad-4c11-9312-34911fabb67b",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\">MERGE INTO gold.connect_enquiry TARGET\n",
       "                      USING df_final_format SOURCE\n",
       "                      ON  TARGET.EnquiryNo = SOURCE.EnquiryNo and TARGET.SourceType = SOURCE.SourceType\n",
       "                      WHEN MATCHED THEN UPDATE SET `RowLastUpdated`=SOURCE.`RowLastUpdated`,`EnquiryNo`=SOURCE.`EnquiryNo`,`Branch`=SOURCE.`Branch`,`EnquiryType`=SOURCE.`EnquiryType`,`LeadCreated`=SOURCE.`LeadCreated`,`LeadType`=SOURCE.`LeadType`,`SourceOfEnquiry`=SOURCE.`SourceOfEnquiry`,`FirstVisit`=SOURCE.`FirstVisit`,`LastVisit`=SOURCE.`LastVisit`,`Demo`=SOURCE.`Demo`,`FirstOrderedPAPrint`=SOURCE.`FirstOrderedPAPrint`,`Status`=SOURCE.`Status`,`LastStatusUpdate`=SOURCE.`LastStatusUpdate`,`SAPOrderNumber`=SOURCE.`SAPOrderNumber`,`NewUsed`=SOURCE.`NewUsed`,`SalesExec`=SOURCE.`SalesExec`,`Customer`=SOURCE.`Customer`,`EIDNumber`=SOURCE.`EIDNumber`,`Make`=SOURCE.`Make`,`Model`=SOURCE.`Model`,`Derivative`=SOURCE.`Derivative`,`Variant`=SOURCE.`Variant`,`ArticleCode`=SOURCE.`ArticleCode`,`VariantCode`=SOURCE.`VariantCode`,`HybrisCampaign`=SOURCE.`HybrisCampaign`,`ExpDeliveryDate`=SOURCE.`ExpDeliveryDate`,`ActDeliveryDate`=SOURCE.`ActDeliveryDate`,`SalesType`=SOURCE.`SalesType`,`FirstOrdered`=SOURCE.`FirstOrdered`,`VIN_No-VIN_Current`=SOURCE.`VIN_No-VIN_Current`,`DateCreated`=SOURCE.`DateCreated`,`AppraisalCompleted`=SOURCE.`AppraisalCompleted`,`TI1stValue`=SOURCE.`TI1stValue`,`TI1stValued`=SOURCE.`TI1stValued`,`TILastValue`=SOURCE.`TILastValue`,`TILastValued`=SOURCE.`TILastValued`,`TILastValueUser`=SOURCE.`TILastValueUser`,`TIAllowance`=SOURCE.`TIAllowance`,`TIAllowanceSet`=SOURCE.`TIAllowanceSet`,`TIAllowanceUserName`=SOURCE.`TIAllowanceUserName`,`TIRemoved`=SOURCE.`TIRemoved`,`TIRemovedUser`=SOURCE.`TIRemovedUser`,`1stOrder`=SOURCE.`1stOrder`,`TI1stValueUser`=SOURCE.`TI1stValueUser`,`BusinessManager`=SOURCE.`BusinessManager`,`1stContact`=SOURCE.`1stContact`,`1stVisit`=SOURCE.`1stVisit`,`CashFinance`=SOURCE.`CashFinance`,`TestDrivePrint`=SOURCE.`TestDrivePrint`,`ReturntoEnquiry`=SOURCE.`ReturntoEnquiry`,`Locator`=SOURCE.`Locator`,`Offer`=SOURCE.`Offer`,`CreateSalesOrder`=SOURCE.`CreateSalesOrder`,`DownPayment`=SOURCE.`DownPayment`,`PurchaseAgreement`=SOURCE.`PurchaseAgreement`,`HUBSubmit`=SOURCE.`HUBSubmit`,`1stApprovedStatus`=SOURCE.`1stApprovedStatus`,`Invoiced`=SOURCE.`Invoiced`,`Delivered`=SOURCE.`Delivered`,`Franchise`=SOURCE.`Franchise`,`Gender`=SOURCE.`Gender`,`Nationality`=SOURCE.`Nationality`,`DOB`=SOURCE.`DOB`,`POBox`=SOURCE.`POBox`,`Emirate`=SOURCE.`Emirate`,`FlatVillaNo`=SOURCE.`FlatVillaNo`,`WayNumber`=SOURCE.`WayNumber`,`BuildingName`=SOURCE.`BuildingName`,`StreetNameNumber`=SOURCE.`StreetNameNumber`,`Area`=SOURCE.`Area`,`Emirate2`=SOURCE.`Emirate2`,`PC`=SOURCE.`PC`,`NearestLandmark`=SOURCE.`NearestLandmark`,`VehicleofInterest`=SOURCE.`VehicleofInterest`,`Employer`=SOURCE.`Employer`,`Salary`=SOURCE.`Salary`,`LostTo`=SOURCE.`LostTo`,`LostReason`=SOURCE.`LostReason`,`BankingWith`=SOURCE.`BankingWith`,`ReceivedDate`=SOURCE.`ReceivedDate`,`LeadChannel`=SOURCE.`LeadChannel`,`LeadSource`=SOURCE.`LeadSource`,`Leadtatus`=SOURCE.`Leadtatus`,`LanguageName`=SOURCE.`LanguageName`,`EnglishForename`=SOURCE.`EnglishForename`,`ArabicForename`=SOURCE.`ArabicForename`,`EnglishSurname`=SOURCE.`EnglishSurname`,`ArabicSurname`=SOURCE.`ArabicSurname`,`EmailAddress`=SOURCE.`EmailAddress`,`PhoneMobile`=SOURCE.`PhoneMobile`,`EnglishMake`=SOURCE.`EnglishMake`,`ArabicMake`=SOURCE.`ArabicMake`,`EnglishModel`=SOURCE.`EnglishModel`,`ArabicModel`=SOURCE.`ArabicModel`,`EnglishComment`=SOURCE.`EnglishComment`,`ArabicComment`=SOURCE.`ArabicComment`,`ExistingCustomer`=SOURCE.`ExistingCustomer`,`UniqueLead`=SOURCE.`UniqueLead`,`ReviewedUser`=SOURCE.`ReviewedUser`,`ReviewedDate`=SOURCE.`ReviewedDate`,`PassToBranchUser`=SOURCE.`PassToBranchUser`,`PassToBranchDate`=SOURCE.`PassToBranchDate`,`AssignedToSalesExecDate`=SOURCE.`AssignedToSalesExecDate`,`AppointmentDate`=SOURCE.`AppointmentDate`,`AppointmentStatusName`=SOURCE.`AppointmentStatusName`,`DemoTaken`=SOURCE.`DemoTaken`,`CloseReasonDescription`=SOURCE.`CloseReasonDescription`,`ClosedDate`=SOURCE.`ClosedDate`,`BDCNextAction`=SOURCE.`BDCNextAction`,`NextActionDate`=SOURCE.`NextActionDate`,`FirstManagementActionDate`=SOURCE.`FirstManagementActionDate`,`ManagementNextActionDate`=SOURCE.`ManagementNextActionDate`,`LastManagementActionDate`=SOURCE.`LastManagementActionDate`,`FirstManagementNotes`=SOURCE.`FirstManagementNotes`,`LastManagementNotes`=SOURCE.`LastManagementNotes`,`FirstActionDate`=SOURCE.`FirstActionDate`,`ManualLead`=SOURCE.`ManualLead`,`ManualLeadCreatedBy`=SOURCE.`ManualLeadCreatedBy`,`LeadURL`=SOURCE.`LeadURL`,`Medium`=SOURCE.`Medium`,`Source`=SOURCE.`Source`,`Campaign`=SOURCE.`Campaign`,`Content`=SOURCE.`Content`,`KeywordsTerm`=SOURCE.`KeywordsTerm`,`SessionCount`=SOURCE.`SessionCount`,`PageViewCount`=SOURCE.`PageViewCount`,`ClientID`=SOURCE.`ClientID`,`BeBacks`=SOURCE.`BeBacks`,`CurrentMake`=SOURCE.`CurrentMake`,`CurrentModel`=SOURCE.`CurrentModel`,`TradeInFlag`=SOURCE.`TradeInFlag`,`ApptCount`=SOURCE.`ApptCount`,`ApptShows`=SOURCE.`ApptShows`,`Customer_ID_Connect`=SOURCE.`Customer_ID_Connect`,`SourceType`=SOURCE.`SourceType`,`BranchId`=SOURCE.`BranchId`,`TradeInMatFlg`=SOURCE.`TradeInMatFlg`,`TradeIn_VIN`=SOURCE.`TradeIn_VIN`,`REJ_REASON`=SOURCE.`REJ_REASON`,`TRPOVAL`=SOURCE.`TRPOVAL`,`TRSTATUSDD`=SOURCE.`TRSTATUSDD`,`REJ_REASON_TR`=SOURCE.`REJ_REASON_TR`,`AEDAT`=SOURCE.`AEDAT`,`BLDAT`=SOURCE.`BLDAT`,`EnquiryCreated`=SOURCE.`EnquiryCreated` ,LOAD_DATE = current_date() \n",
       "                     WHEN NOT MATCHED THEN INSERT (`RowLastUpdated`,`EnquiryNo`,`Branch`,`EnquiryType`,`LeadCreated`,`LeadType`,`SourceOfEnquiry`,`FirstVisit`,`LastVisit`,`Demo`,`FirstOrderedPAPrint`,`Status`,`LastStatusUpdate`,`SAPOrderNumber`,`NewUsed`,`SalesExec`,`Customer`,`EIDNumber`,`Make`,`Model`,`Derivative`,`Variant`,`ArticleCode`,`VariantCode`,`HybrisCampaign`,`ExpDeliveryDate`,`ActDeliveryDate`,`SalesType`,`FirstOrdered`,`VIN_No-VIN_Current`,`DateCreated`,`AppraisalCompleted`,`TI1stValue`,`TI1stValued`,`TILastValue`,`TILastValued`,`TILastValueUser`,`TIAllowance`,`TIAllowanceSet`,`TIAllowanceUserName`,`TIRemoved`,`TIRemovedUser`,`1stOrder`,`TI1stValueUser`,`BusinessManager`,`1stContact`,`1stVisit`,`CashFinance`,`TestDrivePrint`,`ReturntoEnquiry`,`Locator`,`Offer`,`CreateSalesOrder`,`DownPayment`,`PurchaseAgreement`,`HUBSubmit`,`1stApprovedStatus`,`Invoiced`,`Delivered`,`Franchise`,`Gender`,`Nationality`,`DOB`,`POBox`,`Emirate`,`FlatVillaNo`,`WayNumber`,`BuildingName`,`StreetNameNumber`,`Area`,`Emirate2`,`PC`,`NearestLandmark`,`VehicleofInterest`,`Employer`,`Salary`,`LostTo`,`LostReason`,`BankingWith`,`ReceivedDate`,`LeadChannel`,`LeadSource`,`Leadtatus`,`LanguageName`,`EnglishForename`,`ArabicForename`,`EnglishSurname`,`ArabicSurname`,`EmailAddress`,`PhoneMobile`,`EnglishMake`,`ArabicMake`,`EnglishModel`,`ArabicModel`,`EnglishComment`,`ArabicComment`,`ExistingCustomer`,`UniqueLead`,`ReviewedUser`,`ReviewedDate`,`PassToBranchUser`,`PassToBranchDate`,`AssignedToSalesExecDate`,`AppointmentDate`,`AppointmentStatusName`,`DemoTaken`,`CloseReasonDescription`,`ClosedDate`,`BDCNextAction`,`NextActionDate`,`FirstManagementActionDate`,`ManagementNextActionDate`,`LastManagementActionDate`,`FirstManagementNotes`,`LastManagementNotes`,`FirstActionDate`,`ManualLead`,`ManualLeadCreatedBy`,`LeadURL`,`Medium`,`Source`,`Campaign`,`Content`,`KeywordsTerm`,`SessionCount`,`PageViewCount`,`ClientID`,`BeBacks`,`CurrentMake`,`CurrentModel`,`TradeInFlag`,`ApptCount`,`ApptShows`,`Customer_ID_Connect`,`SourceType`,`BranchId`,`TradeInMatFlg`,`TradeIn_VIN`,`REJ_REASON`,`TRPOVAL`,`TRSTATUSDD`,`REJ_REASON_TR`,`AEDAT`,`BLDAT`,`EnquiryCreated`,LOAD_DATE) VALUES(SOURCE.`RowLastUpdated`,SOURCE.`EnquiryNo`,SOURCE.`Branch`,SOURCE.`EnquiryType`,SOURCE.`LeadCreated`,SOURCE.`LeadType`,SOURCE.`SourceOfEnquiry`,SOURCE.`FirstVisit`,SOURCE.`LastVisit`,SOURCE.`Demo`,SOURCE.`FirstOrderedPAPrint`,SOURCE.`Status`,SOURCE.`LastStatusUpdate`,SOURCE.`SAPOrderNumber`,SOURCE.`NewUsed`,SOURCE.`SalesExec`,SOURCE.`Customer`,SOURCE.`EIDNumber`,SOURCE.`Make`,SOURCE.`Model`,SOURCE.`Derivative`,SOURCE.`Variant`,SOURCE.`ArticleCode`,SOURCE.`VariantCode`,SOURCE.`HybrisCampaign`,SOURCE.`ExpDeliveryDate`,SOURCE.`ActDeliveryDate`,SOURCE.`SalesType`,SOURCE.`FirstOrdered`,SOURCE.`VIN_No-VIN_Current`,SOURCE.`DateCreated`,SOURCE.`AppraisalCompleted`,SOURCE.`TI1stValue`,SOURCE.`TI1stValued`,SOURCE.`TILastValue`,SOURCE.`TILastValued`,SOURCE.`TILastValueUser`,SOURCE.`TIAllowance`,SOURCE.`TIAllowanceSet`,SOURCE.`TIAllowanceUserName`,SOURCE.`TIRemoved`,SOURCE.`TIRemovedUser`,SOURCE.`1stOrder`,SOURCE.`TI1stValueUser`,SOURCE.`BusinessManager`,SOURCE.`1stContact`,SOURCE.`1stVisit`,SOURCE.`CashFinance`,SOURCE.`TestDrivePrint`,SOURCE.`ReturntoEnquiry`,SOURCE.`Locator`,SOURCE.`Offer`,SOURCE.`CreateSalesOrder`,SOURCE.`DownPayment`,SOURCE.`PurchaseAgreement`,SOURCE.`HUBSubmit`,SOURCE.`1stApprovedStatus`,SOURCE.`Invoiced`,SOURCE.`Delivered`,SOURCE.`Franchise`,SOURCE.`Gender`,SOURCE.`Nationality`,SOURCE.`DOB`,SOURCE.`POBox`,SOURCE.`Emirate`,SOURCE.`FlatVillaNo`,SOURCE.`WayNumber`,SOURCE.`BuildingName`,SOURCE.`StreetNameNumber`,SOURCE.`Area`,SOURCE.`Emirate2`,SOURCE.`PC`,SOURCE.`NearestLandmark`,SOURCE.`VehicleofInterest`,SOURCE.`Employer`,SOURCE.`Salary`,SOURCE.`LostTo`,SOURCE.`LostReason`,SOURCE.`BankingWith`,SOURCE.`ReceivedDate`,SOURCE.`LeadChannel`,SOURCE.`LeadSource`,SOURCE.`Leadtatus`,SOURCE.`LanguageName`,SOURCE.`EnglishForename`,SOURCE.`ArabicForename`,SOURCE.`EnglishSurname`,SOURCE.`ArabicSurname`,SOURCE.`EmailAddress`,SOURCE.`PhoneMobile`,SOURCE.`EnglishMake`,SOURCE.`ArabicMake`,SOURCE.`EnglishModel`,SOURCE.`ArabicModel`,SOURCE.`EnglishComment`,SOURCE.`ArabicComment`,SOURCE.`ExistingCustomer`,SOURCE.`UniqueLead`,SOURCE.`ReviewedUser`,SOURCE.`ReviewedDate`,SOURCE.`PassToBranchUser`,SOURCE.`PassToBranchDate`,SOURCE.`AssignedToSalesExecDate`,SOURCE.`AppointmentDate`,SOURCE.`AppointmentStatusName`,SOURCE.`DemoTaken`,SOURCE.`CloseReasonDescription`,SOURCE.`ClosedDate`,SOURCE.`BDCNextAction`,SOURCE.`NextActionDate`,SOURCE.`FirstManagementActionDate`,SOURCE.`ManagementNextActionDate`,SOURCE.`LastManagementActionDate`,SOURCE.`FirstManagementNotes`,SOURCE.`LastManagementNotes`,SOURCE.`FirstActionDate`,SOURCE.`ManualLead`,SOURCE.`ManualLeadCreatedBy`,SOURCE.`LeadURL`,SOURCE.`Medium`,SOURCE.`Source`,SOURCE.`Campaign`,SOURCE.`Content`,SOURCE.`KeywordsTerm`,SOURCE.`SessionCount`,SOURCE.`PageViewCount`,SOURCE.`ClientID`,SOURCE.`BeBacks`,SOURCE.`CurrentMake`,SOURCE.`CurrentModel`,SOURCE.`TradeInFlag`,SOURCE.`ApptCount`,SOURCE.`ApptShows`,SOURCE.`Customer_ID_Connect`,SOURCE.`SourceType`,SOURCE.`BranchId`,SOURCE.`TradeInMatFlg`,SOURCE.`TradeIn_VIN`,SOURCE.`REJ_REASON`,SOURCE.`TRPOVAL`,SOURCE.`TRSTATUSDD`,SOURCE.`REJ_REASON_TR`,SOURCE.`AEDAT`,SOURCE.`BLDAT`,SOURCE.`EnquiryCreated` , current_date())\n",
       "</div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\">MERGE INTO gold.connect_enquiry TARGET\n                      USING df_final_format SOURCE\n                      ON  TARGET.EnquiryNo = SOURCE.EnquiryNo and TARGET.SourceType = SOURCE.SourceType\n                      WHEN MATCHED THEN UPDATE SET `RowLastUpdated`=SOURCE.`RowLastUpdated`,`EnquiryNo`=SOURCE.`EnquiryNo`,`Branch`=SOURCE.`Branch`,`EnquiryType`=SOURCE.`EnquiryType`,`LeadCreated`=SOURCE.`LeadCreated`,`LeadType`=SOURCE.`LeadType`,`SourceOfEnquiry`=SOURCE.`SourceOfEnquiry`,`FirstVisit`=SOURCE.`FirstVisit`,`LastVisit`=SOURCE.`LastVisit`,`Demo`=SOURCE.`Demo`,`FirstOrderedPAPrint`=SOURCE.`FirstOrderedPAPrint`,`Status`=SOURCE.`Status`,`LastStatusUpdate`=SOURCE.`LastStatusUpdate`,`SAPOrderNumber`=SOURCE.`SAPOrderNumber`,`NewUsed`=SOURCE.`NewUsed`,`SalesExec`=SOURCE.`SalesExec`,`Customer`=SOURCE.`Customer`,`EIDNumber`=SOURCE.`EIDNumber`,`Make`=SOURCE.`Make`,`Model`=SOURCE.`Model`,`Derivative`=SOURCE.`Derivative`,`Variant`=SOURCE.`Variant`,`ArticleCode`=SOURCE.`ArticleCode`,`VariantCode`=SOURCE.`VariantCode`,`HybrisCampaign`=SOURCE.`HybrisCampaign`,`ExpDeliveryDate`=SOURCE.`ExpDeliveryDate`,`ActDeliveryDate`=SOURCE.`ActDeliveryDate`,`SalesType`=SOURCE.`SalesType`,`FirstOrdered`=SOURCE.`FirstOrdered`,`VIN_No-VIN_Current`=SOURCE.`VIN_No-VIN_Current`,`DateCreated`=SOURCE.`DateCreated`,`AppraisalCompleted`=SOURCE.`AppraisalCompleted`,`TI1stValue`=SOURCE.`TI1stValue`,`TI1stValued`=SOURCE.`TI1stValued`,`TILastValue`=SOURCE.`TILastValue`,`TILastValued`=SOURCE.`TILastValued`,`TILastValueUser`=SOURCE.`TILastValueUser`,`TIAllowance`=SOURCE.`TIAllowance`,`TIAllowanceSet`=SOURCE.`TIAllowanceSet`,`TIAllowanceUserName`=SOURCE.`TIAllowanceUserName`,`TIRemoved`=SOURCE.`TIRemoved`,`TIRemovedUser`=SOURCE.`TIRemovedUser`,`1stOrder`=SOURCE.`1stOrder`,`TI1stValueUser`=SOURCE.`TI1stValueUser`,`BusinessManager`=SOURCE.`BusinessManager`,`1stContact`=SOURCE.`1stContact`,`1stVisit`=SOURCE.`1stVisit`,`CashFinance`=SOURCE.`CashFinance`,`TestDrivePrint`=SOURCE.`TestDrivePrint`,`ReturntoEnquiry`=SOURCE.`ReturntoEnquiry`,`Locator`=SOURCE.`Locator`,`Offer`=SOURCE.`Offer`,`CreateSalesOrder`=SOURCE.`CreateSalesOrder`,`DownPayment`=SOURCE.`DownPayment`,`PurchaseAgreement`=SOURCE.`PurchaseAgreement`,`HUBSubmit`=SOURCE.`HUBSubmit`,`1stApprovedStatus`=SOURCE.`1stApprovedStatus`,`Invoiced`=SOURCE.`Invoiced`,`Delivered`=SOURCE.`Delivered`,`Franchise`=SOURCE.`Franchise`,`Gender`=SOURCE.`Gender`,`Nationality`=SOURCE.`Nationality`,`DOB`=SOURCE.`DOB`,`POBox`=SOURCE.`POBox`,`Emirate`=SOURCE.`Emirate`,`FlatVillaNo`=SOURCE.`FlatVillaNo`,`WayNumber`=SOURCE.`WayNumber`,`BuildingName`=SOURCE.`BuildingName`,`StreetNameNumber`=SOURCE.`StreetNameNumber`,`Area`=SOURCE.`Area`,`Emirate2`=SOURCE.`Emirate2`,`PC`=SOURCE.`PC`,`NearestLandmark`=SOURCE.`NearestLandmark`,`VehicleofInterest`=SOURCE.`VehicleofInterest`,`Employer`=SOURCE.`Employer`,`Salary`=SOURCE.`Salary`,`LostTo`=SOURCE.`LostTo`,`LostReason`=SOURCE.`LostReason`,`BankingWith`=SOURCE.`BankingWith`,`ReceivedDate`=SOURCE.`ReceivedDate`,`LeadChannel`=SOURCE.`LeadChannel`,`LeadSource`=SOURCE.`LeadSource`,`Leadtatus`=SOURCE.`Leadtatus`,`LanguageName`=SOURCE.`LanguageName`,`EnglishForename`=SOURCE.`EnglishForename`,`ArabicForename`=SOURCE.`ArabicForename`,`EnglishSurname`=SOURCE.`EnglishSurname`,`ArabicSurname`=SOURCE.`ArabicSurname`,`EmailAddress`=SOURCE.`EmailAddress`,`PhoneMobile`=SOURCE.`PhoneMobile`,`EnglishMake`=SOURCE.`EnglishMake`,`ArabicMake`=SOURCE.`ArabicMake`,`EnglishModel`=SOURCE.`EnglishModel`,`ArabicModel`=SOURCE.`ArabicModel`,`EnglishComment`=SOURCE.`EnglishComment`,`ArabicComment`=SOURCE.`ArabicComment`,`ExistingCustomer`=SOURCE.`ExistingCustomer`,`UniqueLead`=SOURCE.`UniqueLead`,`ReviewedUser`=SOURCE.`ReviewedUser`,`ReviewedDate`=SOURCE.`ReviewedDate`,`PassToBranchUser`=SOURCE.`PassToBranchUser`,`PassToBranchDate`=SOURCE.`PassToBranchDate`,`AssignedToSalesExecDate`=SOURCE.`AssignedToSalesExecDate`,`AppointmentDate`=SOURCE.`AppointmentDate`,`AppointmentStatusName`=SOURCE.`AppointmentStatusName`,`DemoTaken`=SOURCE.`DemoTaken`,`CloseReasonDescription`=SOURCE.`CloseReasonDescription`,`ClosedDate`=SOURCE.`ClosedDate`,`BDCNextAction`=SOURCE.`BDCNextAction`,`NextActionDate`=SOURCE.`NextActionDate`,`FirstManagementActionDate`=SOURCE.`FirstManagementActionDate`,`ManagementNextActionDate`=SOURCE.`ManagementNextActionDate`,`LastManagementActionDate`=SOURCE.`LastManagementActionDate`,`FirstManagementNotes`=SOURCE.`FirstManagementNotes`,`LastManagementNotes`=SOURCE.`LastManagementNotes`,`FirstActionDate`=SOURCE.`FirstActionDate`,`ManualLead`=SOURCE.`ManualLead`,`ManualLeadCreatedBy`=SOURCE.`ManualLeadCreatedBy`,`LeadURL`=SOURCE.`LeadURL`,`Medium`=SOURCE.`Medium`,`Source`=SOURCE.`Source`,`Campaign`=SOURCE.`Campaign`,`Content`=SOURCE.`Content`,`KeywordsTerm`=SOURCE.`KeywordsTerm`,`SessionCount`=SOURCE.`SessionCount`,`PageViewCount`=SOURCE.`PageViewCount`,`ClientID`=SOURCE.`ClientID`,`BeBacks`=SOURCE.`BeBacks`,`CurrentMake`=SOURCE.`CurrentMake`,`CurrentModel`=SOURCE.`CurrentModel`,`TradeInFlag`=SOURCE.`TradeInFlag`,`ApptCount`=SOURCE.`ApptCount`,`ApptShows`=SOURCE.`ApptShows`,`Customer_ID_Connect`=SOURCE.`Customer_ID_Connect`,`SourceType`=SOURCE.`SourceType`,`BranchId`=SOURCE.`BranchId`,`TradeInMatFlg`=SOURCE.`TradeInMatFlg`,`TradeIn_VIN`=SOURCE.`TradeIn_VIN`,`REJ_REASON`=SOURCE.`REJ_REASON`,`TRPOVAL`=SOURCE.`TRPOVAL`,`TRSTATUSDD`=SOURCE.`TRSTATUSDD`,`REJ_REASON_TR`=SOURCE.`REJ_REASON_TR`,`AEDAT`=SOURCE.`AEDAT`,`BLDAT`=SOURCE.`BLDAT`,`EnquiryCreated`=SOURCE.`EnquiryCreated` ,LOAD_DATE = current_date() \n                     WHEN NOT MATCHED THEN INSERT (`RowLastUpdated`,`EnquiryNo`,`Branch`,`EnquiryType`,`LeadCreated`,`LeadType`,`SourceOfEnquiry`,`FirstVisit`,`LastVisit`,`Demo`,`FirstOrderedPAPrint`,`Status`,`LastStatusUpdate`,`SAPOrderNumber`,`NewUsed`,`SalesExec`,`Customer`,`EIDNumber`,`Make`,`Model`,`Derivative`,`Variant`,`ArticleCode`,`VariantCode`,`HybrisCampaign`,`ExpDeliveryDate`,`ActDeliveryDate`,`SalesType`,`FirstOrdered`,`VIN_No-VIN_Current`,`DateCreated`,`AppraisalCompleted`,`TI1stValue`,`TI1stValued`,`TILastValue`,`TILastValued`,`TILastValueUser`,`TIAllowance`,`TIAllowanceSet`,`TIAllowanceUserName`,`TIRemoved`,`TIRemovedUser`,`1stOrder`,`TI1stValueUser`,`BusinessManager`,`1stContact`,`1stVisit`,`CashFinance`,`TestDrivePrint`,`ReturntoEnquiry`,`Locator`,`Offer`,`CreateSalesOrder`,`DownPayment`,`PurchaseAgreement`,`HUBSubmit`,`1stApprovedStatus`,`Invoiced`,`Delivered`,`Franchise`,`Gender`,`Nationality`,`DOB`,`POBox`,`Emirate`,`FlatVillaNo`,`WayNumber`,`BuildingName`,`StreetNameNumber`,`Area`,`Emirate2`,`PC`,`NearestLandmark`,`VehicleofInterest`,`Employer`,`Salary`,`LostTo`,`LostReason`,`BankingWith`,`ReceivedDate`,`LeadChannel`,`LeadSource`,`Leadtatus`,`LanguageName`,`EnglishForename`,`ArabicForename`,`EnglishSurname`,`ArabicSurname`,`EmailAddress`,`PhoneMobile`,`EnglishMake`,`ArabicMake`,`EnglishModel`,`ArabicModel`,`EnglishComment`,`ArabicComment`,`ExistingCustomer`,`UniqueLead`,`ReviewedUser`,`ReviewedDate`,`PassToBranchUser`,`PassToBranchDate`,`AssignedToSalesExecDate`,`AppointmentDate`,`AppointmentStatusName`,`DemoTaken`,`CloseReasonDescription`,`ClosedDate`,`BDCNextAction`,`NextActionDate`,`FirstManagementActionDate`,`ManagementNextActionDate`,`LastManagementActionDate`,`FirstManagementNotes`,`LastManagementNotes`,`FirstActionDate`,`ManualLead`,`ManualLeadCreatedBy`,`LeadURL`,`Medium`,`Source`,`Campaign`,`Content`,`KeywordsTerm`,`SessionCount`,`PageViewCount`,`ClientID`,`BeBacks`,`CurrentMake`,`CurrentModel`,`TradeInFlag`,`ApptCount`,`ApptShows`,`Customer_ID_Connect`,`SourceType`,`BranchId`,`TradeInMatFlg`,`TradeIn_VIN`,`REJ_REASON`,`TRPOVAL`,`TRSTATUSDD`,`REJ_REASON_TR`,`AEDAT`,`BLDAT`,`EnquiryCreated`,LOAD_DATE) VALUES(SOURCE.`RowLastUpdated`,SOURCE.`EnquiryNo`,SOURCE.`Branch`,SOURCE.`EnquiryType`,SOURCE.`LeadCreated`,SOURCE.`LeadType`,SOURCE.`SourceOfEnquiry`,SOURCE.`FirstVisit`,SOURCE.`LastVisit`,SOURCE.`Demo`,SOURCE.`FirstOrderedPAPrint`,SOURCE.`Status`,SOURCE.`LastStatusUpdate`,SOURCE.`SAPOrderNumber`,SOURCE.`NewUsed`,SOURCE.`SalesExec`,SOURCE.`Customer`,SOURCE.`EIDNumber`,SOURCE.`Make`,SOURCE.`Model`,SOURCE.`Derivative`,SOURCE.`Variant`,SOURCE.`ArticleCode`,SOURCE.`VariantCode`,SOURCE.`HybrisCampaign`,SOURCE.`ExpDeliveryDate`,SOURCE.`ActDeliveryDate`,SOURCE.`SalesType`,SOURCE.`FirstOrdered`,SOURCE.`VIN_No-VIN_Current`,SOURCE.`DateCreated`,SOURCE.`AppraisalCompleted`,SOURCE.`TI1stValue`,SOURCE.`TI1stValued`,SOURCE.`TILastValue`,SOURCE.`TILastValued`,SOURCE.`TILastValueUser`,SOURCE.`TIAllowance`,SOURCE.`TIAllowanceSet`,SOURCE.`TIAllowanceUserName`,SOURCE.`TIRemoved`,SOURCE.`TIRemovedUser`,SOURCE.`1stOrder`,SOURCE.`TI1stValueUser`,SOURCE.`BusinessManager`,SOURCE.`1stContact`,SOURCE.`1stVisit`,SOURCE.`CashFinance`,SOURCE.`TestDrivePrint`,SOURCE.`ReturntoEnquiry`,SOURCE.`Locator`,SOURCE.`Offer`,SOURCE.`CreateSalesOrder`,SOURCE.`DownPayment`,SOURCE.`PurchaseAgreement`,SOURCE.`HUBSubmit`,SOURCE.`1stApprovedStatus`,SOURCE.`Invoiced`,SOURCE.`Delivered`,SOURCE.`Franchise`,SOURCE.`Gender`,SOURCE.`Nationality`,SOURCE.`DOB`,SOURCE.`POBox`,SOURCE.`Emirate`,SOURCE.`FlatVillaNo`,SOURCE.`WayNumber`,SOURCE.`BuildingName`,SOURCE.`StreetNameNumber`,SOURCE.`Area`,SOURCE.`Emirate2`,SOURCE.`PC`,SOURCE.`NearestLandmark`,SOURCE.`VehicleofInterest`,SOURCE.`Employer`,SOURCE.`Salary`,SOURCE.`LostTo`,SOURCE.`LostReason`,SOURCE.`BankingWith`,SOURCE.`ReceivedDate`,SOURCE.`LeadChannel`,SOURCE.`LeadSource`,SOURCE.`Leadtatus`,SOURCE.`LanguageName`,SOURCE.`EnglishForename`,SOURCE.`ArabicForename`,SOURCE.`EnglishSurname`,SOURCE.`ArabicSurname`,SOURCE.`EmailAddress`,SOURCE.`PhoneMobile`,SOURCE.`EnglishMake`,SOURCE.`ArabicMake`,SOURCE.`EnglishModel`,SOURCE.`ArabicModel`,SOURCE.`EnglishComment`,SOURCE.`ArabicComment`,SOURCE.`ExistingCustomer`,SOURCE.`UniqueLead`,SOURCE.`ReviewedUser`,SOURCE.`ReviewedDate`,SOURCE.`PassToBranchUser`,SOURCE.`PassToBranchDate`,SOURCE.`AssignedToSalesExecDate`,SOURCE.`AppointmentDate`,SOURCE.`AppointmentStatusName`,SOURCE.`DemoTaken`,SOURCE.`CloseReasonDescription`,SOURCE.`ClosedDate`,SOURCE.`BDCNextAction`,SOURCE.`NextActionDate`,SOURCE.`FirstManagementActionDate`,SOURCE.`ManagementNextActionDate`,SOURCE.`LastManagementActionDate`,SOURCE.`FirstManagementNotes`,SOURCE.`LastManagementNotes`,SOURCE.`FirstActionDate`,SOURCE.`ManualLead`,SOURCE.`ManualLeadCreatedBy`,SOURCE.`LeadURL`,SOURCE.`Medium`,SOURCE.`Source`,SOURCE.`Campaign`,SOURCE.`Content`,SOURCE.`KeywordsTerm`,SOURCE.`SessionCount`,SOURCE.`PageViewCount`,SOURCE.`ClientID`,SOURCE.`BeBacks`,SOURCE.`CurrentMake`,SOURCE.`CurrentModel`,SOURCE.`TradeInFlag`,SOURCE.`ApptCount`,SOURCE.`ApptShows`,SOURCE.`Customer_ID_Connect`,SOURCE.`SourceType`,SOURCE.`BranchId`,SOURCE.`TradeInMatFlg`,SOURCE.`TradeIn_VIN`,SOURCE.`REJ_REASON`,SOURCE.`TRPOVAL`,SOURCE.`TRSTATUSDD`,SOURCE.`REJ_REASON_TR`,SOURCE.`AEDAT`,SOURCE.`BLDAT`,SOURCE.`EnquiryCreated` , current_date())\n</div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "merge_statement = \"\"\"MERGE INTO gold.enquiry TARGET\n",
    "                      USING df_final_format SOURCE\n",
    "                      ON  TARGET.EnquiryNo = SOURCE.EnquiryNo and TARGET.SourceType = SOURCE.SourceType\n",
    "                      WHEN MATCHED THEN {final_update_statement} \n",
    "                     WHEN NOT MATCHED THEN {final_insert_statement}\"\"\".format\\\n",
    "                     (final_update_statement=final_update_statement,final_insert_statement=final_insert_statement)\n",
    "\n",
    "print(merge_statement)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {
    "application/vnd.databricks.v1+cell": {
     "cellMetadata": {
      "byteLimit": 2048000,
      "rowLimit": 10000
     },
     "inputWidgets": {},
     "nuid": "2cb53167-ac3e-4a1c-8805-7a4b95ef2084",
     "showTitle": false,
     "title": ""
    }
   },
   "outputs": [
    {
     "output_type": "display_data",
     "data": {
      "text/html": [
       "<style scoped>\n",
       "  .ansiout {\n",
       "    display: block;\n",
       "    unicode-bidi: embed;\n",
       "    white-space: pre-wrap;\n",
       "    word-wrap: break-word;\n",
       "    word-break: break-all;\n",
       "    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n",
       "    font-size: 13px;\n",
       "    color: #555;\n",
       "    margin-left: 4px;\n",
       "    line-height: 19px;\n",
       "  }\n",
       "</style>\n",
       "<div class=\"ansiout\">Out[29]: DataFrame[num_affected_rows: bigint, num_updated_rows: bigint, num_deleted_rows: bigint, num_inserted_rows: bigint]</div>"
      ]
     },
     "metadata": {
      "application/vnd.databricks.v1+output": {
       "addedWidgets": {},
       "arguments": {},
       "data": "<div class=\"ansiout\">Out[29]: DataFrame[num_affected_rows: bigint, num_updated_rows: bigint, num_deleted_rows: bigint, num_inserted_rows: bigint]</div>",
       "datasetInfos": [],
       "metadata": {},
       "removedWidgets": [],
       "type": "html"
      }
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "spark.sql(merge_statement)"
   ]
  }
 ],
 "metadata": {
  "application/vnd.databricks.v1+notebook": {
   "dashboards": [],
   "language": "python",
   "notebookMetadata": {
    "mostRecentlyExecutedCommandWithImplicitDF": {
     "commandId": 2816454289064975,
     "dataframes": [
      "_sqldf"
     ]
    },
    "pythonIndentUnit": 2
   },
   "notebookName": "Demo Notebook",
   "widgets": {}
  }
 },
 "nbformat": 4,
 "nbformat_minor": 0
}
